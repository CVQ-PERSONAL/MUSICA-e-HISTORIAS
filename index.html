<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>M√∫sica e Historias</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg-gradient: radial-gradient(circle at top, #4f46e5 0, #020617 45%, #000 100%);
      --card-bg: rgba(15, 23, 42, 0.96);
      --card-soft: rgba(15, 23, 42, 0.9);
      --accent: #fb923c;
      --accent-soft: #fed7aa;
      --pill-bg: #020617;
      --pill-active: linear-gradient(135deg,#fb923c,#f97316);
      --pill-text: #f9fafb;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-soft: rgba(148, 163, 184, 0.25);
      --danger: #f97373;
      --success: #22c55e;
      --input-bg: #020617;
      --input-border: #1f2937;
      --shadow-soft: 0 22px 50px rgba(15, 23, 42, 0.9);
      --radius-lg: 24px;
      --radius-md: 16px;
      --radius-pill: 999px;
      --transition-fast: 0.15s ease-out;
      --transition-med: 0.22s ease-out;
      --font-main: system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-main);
      color: var(--text-main);
      background: var(--bg-gradient);
      background-attachment: fixed;
      -webkit-font-smoothing: antialiased;
    }
    .page { max-width: 980px; margin: 0 auto; padding: 24px 16px 40px; }
    header { margin-bottom: 18px; }
    h1 { margin: 0; font-size: clamp(2.2rem, 3vw, 2.8rem); letter-spacing: 0.03em; }
    .subtitle {
      margin-top: 6px;
      font-size: 0.95rem;
      color: var(--text-muted);
      max-width: 640px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-top: 18px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }
    .tab {
      border-radius: var(--radius-pill);
      padding: 8px 18px;
      background: var(--pill-bg);
      color: var(--text-muted);
      font-size: 0.9rem;
      border: 1px solid transparent;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: background var(--transition-med), color var(--transition-med),
                  transform var(--transition-fast), box-shadow var(--transition-fast),
                  border-color var(--transition-fast);
    }
    .tab span.count {
      font-size: 0.75rem;
      padding: 2px 9px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
    }
    .tab.active {
      background: var(--pill-active);
      color: var(--pill-text);
      box-shadow: 0 12px 25px rgba(248, 113, 113, 0.3);
      border-color: rgba(248, 250, 252, 0.18);
      transform: translateY(-1px);
    }
    .tab.active span.count { background: rgba(15,23,42,0.9); }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 18px 16px 20px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.18);
    }
    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    .card-title { font-size: 1.2rem; letter-spacing: 0.08em; text-transform: uppercase; }
    .card-subtitle { font-size: 0.8rem; color: var(--text-muted); }

    .song-layout {
      display: grid;
      grid-template-columns: minmax(0, 42%) minmax(0, 58%);
      gap: 16px;
    }
    @media (max-width: 768px) {
      .song-layout { grid-template-columns: minmax(0,1fr); }
    }

    .field-group { margin-bottom: 10px; }
    label {
      font-size: 0.74rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      display: block;
      margin-bottom: 4px;
    }
    select,
    input[type="text"],
    textarea,
    input[type="password"] {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-main);
      padding: 9px 12px;
      font-size: 0.9rem;
      outline: none;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast),
                  background var(--transition-fast), color var(--transition-fast);
    }
    textarea {
      border-radius: 12px;
      resize: vertical;
      min-height: 80px;
      font-size: 0.92rem;
      line-height: 1.38;
    }
    select:focus,
    input[type="text"]:focus,
    input[type="password"]:focus,
    textarea:focus {
      border-color: #f97316;
      box-shadow: 0 0 0 1px rgba(248, 113, 22, 0.35);
    }

    .search-input { padding-left: 34px; }
    .search-wrapper { position: relative; }
    .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.9rem;
      pointer-events: none;
      opacity: 0.9;
    }

    .list {
      margin-top: 8px;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.35),
        rgba(15, 23, 42, 0.96));
      max-height: 420px;
      overflow-y: auto;
    }
    .list-item {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.9);
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast);
    }
    .list-item:last-child { border-bottom: none; }
    .list-item:hover { background: rgba(30,64,175,0.45); transform: translateY(-1px); }
    .list-item.active { background: rgba(248,113,22,0.22); }
    .list-item-title { font-weight: 600; }
    .list-item-meta { font-size: 0.8rem; color: var(--text-muted); }

    .detail-card {
      background: var(--card-soft);
      border-radius: var(--radius-md);
      padding: 14px 14px 12px;
      border: 1px solid rgba(55, 65, 81, 0.7);
      min-height: 200px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .detail-heading {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 4px;
    }
    .detail-title {
      font-size: 1.05rem;
      font-weight: 600;
    }
    .detail-row { display: flex; gap: 6px; font-size: 0.88rem; }
    .detail-label { min-width: 90px; font-weight: 600; color: var(--text-muted); }
    .detail-value { flex: 1; }
    .pill-genre {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(30, 64, 175, 0.55);
    }
    .history-text {
      font-size: 0.9rem;
      line-height: 1.4;
      color: #e5e7eb;
      margin-top: 4px;
    }
    .btn-link {
      border: none;
      background: none;
      color: var(--accent-soft);
      font-size: 0.8rem;
      padding: 0;
      cursor: pointer;
      text-decoration: underline;
    }
    .btn-link:hover { color: #fed7aa; }
    .video-link {
      color: #93c5fd;
      font-size: 0.85rem;
      text-decoration: underline;
    }
    .video-link:hover { color: #bfdbfe; }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
    }
    .btn {
      border-radius: var(--radius-pill);
      border: none;
      padding: 8px 16px;
      font-size: 0.86rem;
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast),
                  box-shadow var(--transition-fast);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg,#fb923c,#f97316);
      color: #111827;
      box-shadow: 0 12px 25px rgba(248, 113, 22, 0.4);
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 16px 32px rgba(248,113,22,0.6); }
    .btn-secondary {
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }
    .btn-secondary:hover { background: #111827; transform: translateY(-1px); }
    .btn-danger {
      background: #7f1d1d;
      color: #fecaca;
      border: 1px solid #b91c1c;
    }
    .btn-danger:hover { background: #991b1b; }

    .status-message { margin-top: 8px; font-size: 0.8rem; }
    .status-ok { color: var(--success); }
    .status-error { color: var(--danger); }
    .status-muted { color: var(--text-muted); }

    .admin-grid {
      display: grid;
      grid-template-columns: minmax(0, 40%) minmax(0, 60%);
      gap: 16px;
    }
    @media (max-width: 768px) {
      .admin-grid { grid-template-columns: minmax(0,1fr); }
    }
    .admin-fieldset {
      background: rgba(15, 23, 42, 0.96);
      border-radius: var(--radius-md);
      padding: 12px 12px 10px;
      border: 1px solid rgba(55, 65, 81, 0.7);
    }
    .admin-small { font-size: 0.78rem; color: var(--text-muted); }
    .input-inline { display: flex; gap: 8px; align-items: center; }
    .input-inline input[type="text"] { flex: 1; }

    /* Overlay login admin */
    .admin-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .admin-dialog {
      background: #020617;
      border-radius: 18px;
      padding: 18px 16px 16px;
      max-width: 360px;
      width: 92%;
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: var(--shadow-soft);
    }
    .admin-dialog h2 {
      margin: 0 0 6px;
      font-size: 1.1rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }
    .admin-dialog p {
      margin: 0 0 12px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .author-name { font-weight: 600; }
    .curio-title { font-weight: 600; }

  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>M√∫sica e Historias</h1>
      <p class="subtitle">
        Canciones con historia, cantantes y curiosidades de la m√∫sica latina.
      </p>

      <div class="tabs">
        <button class="tab active" data-tab="canciones">
          Canciones <span class="count" id="countCanciones">0</span>
        </button>
        <button class="tab" data-tab="autores">
          Cantantes / Autores <span class="count" id="countAutores">0</span>
        </button>
        <button class="tab" data-tab="curiosidades">
          Curiosidades <span class="count" id="countCuriosidades">0</span>
        </button>
        <button class="tab" data-tab="admin">
          Admin
        </button>
      </div>
    </header>

    <!-- CANCIONES -->
    <section id="tab-canciones" class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Canciones</div>
          <div class="card-subtitle">Explora por g√©nero, int√©rprete o busca por t√≠tulo.</div>
        </div>
      </div>

      <div class="song-layout">
        <!-- LADO IZQUIERDO: filtros + lista -->
        <div>
          <div class="field-group">
            <label for="songFilterType">Filtrar por</label>
            <select id="songFilterType">
              <option value="todos">Todos</option>
              <option value="genero">G√©nero</option>
              <option value="interprete">Int√©rprete</option>
            </select>
          </div>

          <div class="field-group">
            <label for="songFilterValue">(Opciones)</label>
            <select id="songFilterValue">
              <option value="todos">(todos)</option>
            </select>
          </div>

          <div class="field-group">
            <label for="songSort">Ordenar por</label>
            <select id="songSort">
              <option value="az">A ‚Üí Z</option>
              <option value="za">Z ‚Üí A</option>
            </select>
          </div>

          <div class="field-group">
            <label for="songSearch">Buscar canci√≥n</label>
            <div class="search-wrapper">
              <span class="search-icon">üîç</span>
              <input type="text" id="songSearch" class="search-input"
                     placeholder="Escribe parte del t√≠tulo o del int√©rprete" />
            </div>
          </div>

          <div id="songList" class="list"></div>
        </div>

        <!-- LADO DERECHO: detalle protagonista -->
        <div>
          <div class="detail-card" id="songDetail">
            <div class="detail-heading">
              <div class="detail-title" id="detailTitulo">Selecciona una canci√≥n en la lista</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Int√©rprete</div>
              <div class="detail-value" id="detailInterprete">ND</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Compositor</div>
              <div class="detail-value" id="detailCompositor">ND</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">G√©nero</div>
              <div class="detail-value" id="detailGenero"><span class="pill-genre">ND</span></div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Tomado de</div>
              <div class="detail-value" id="detailTomadoDe">ND</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Video</div>
              <div class="detail-value" id="detailVideo">ND</div>
            </div>
            <div class="detail-row" style="align-items:flex-start;">
              <div class="detail-label">Historia</div>
              <div class="detail-value">
                <div id="detailHistoria" class="history-text">ND</div>
                <button id="btnHistoriaToggle" class="btn-link" style="display:none;">Ver m√°s</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- AUTORES -->
    <section id="tab-autores" class="card" style="display:none;">
      <div class="card-header">
        <div>
          <div class="card-title">Cantantes / Autores</div>
          <div class="card-subtitle">Int√©rpretes y compositores con sus datos b√°sicos.</div>
        </div>
      </div>

      <div class="field-group">
        <label for="authorSearch">Buscar autor</label>
        <div class="search-wrapper">
          <span class="search-icon">üîç</span>
          <input type="text" id="authorSearch" class="search-input"
                 placeholder="Escribe parte del nombre art√≠stico o real" />
        </div>
      </div>

      <div id="authorList" class="list"></div>
    </section>

    <!-- CURIOSIDADES -->
    <section id="tab-curiosidades" class="card" style="display:none;">
      <div class="card-header">
        <div>
          <div class="card-title">Curiosidades</div>
          <div class="card-subtitle">Historias cortas y datos curiosos de la m√∫sica.</div>
        </div>
      </div>

      <div id="curiosidadesList" class="list"></div>
    </section>

    <!-- ADMIN -->
    <section id="tab-admin" class="card" style="display:none;">
      <div class="card-header">
        <div>
          <div class="card-title">Administraci√≥n</div>
          <div class="card-subtitle">
            Edici√≥n en l√≠nea. Los cambios se guardan directamente en Supabase.
          </div>
        </div>
        <div style="font-size:0.8rem;color:var(--text-muted);">
          Estado: <span id="adminState">Conectando‚Ä¶</span>
        </div>
      </div>

      <div class="admin-grid">
        <!-- Lado izquierdo: selecci√≥n y acciones -->
        <div class="admin-fieldset">
          <div class="field-group">
            <label for="adminCategory">Categor√≠a</label>
            <select id="adminCategory">
              <option value="canciones">Canciones</option>
              <option value="autores">Cantantes / Autores</option>
              <option value="curiosidades">Curiosidades</option>
            </select>
          </div>

          <div class="field-group">
            <label for="adminSearchItem">Buscar √≠tem</label>
            <input type="text" id="adminSearchItem" placeholder="Escribe parte del t√≠tulo o nombre" />
          </div>

          <div class="field-group">
            <label for="adminItemSelect">√çtem</label>
            <select id="adminItemSelect"></select>
          </div>

          <div class="btn-row" style="margin-top:10px;">
            <button class="btn btn-primary" id="btnGuardar">Guardar cambios</button>
            <button class="btn btn-secondary" id="btnNuevoItem">‚ûï Agregar √≠tem</button>
          </div>

          <div class="btn-row" style="margin-top:6px;">
            <button class="btn btn-secondary" id="btnImportCsv">üìÅ Importar CSV</button>
            <button class="btn btn-secondary" id="btnRefrescar">üîÑ Refrescar</button>
            <button class="btn btn-danger" id="btnEliminar">üóëÔ∏è Eliminar</button>
          </div>

          <input type="file" id="csvFileInput" accept=".csv" style="display:none;" />

          <div class="status-message status-muted" id="adminInfo">
            Selecciona o crea un √≠tem para editarlo.
          </div>
        </div>

        <!-- Lado derecho: formularios por categor√≠a -->
        <div class="admin-fieldset">
          <!-- CANCIONES -->
          <div id="adminFormCanciones">
            <div class="field-group">
              <label for="adminSongTitulo">Canci√≥n</label>
              <input type="text" id="adminSongTitulo" />
            </div>
            <div class="field-group">
              <label for="adminSongInterprete">Int√©rprete</label>
              <input type="text" id="adminSongInterprete" />
            </div>
            <div class="field-group">
              <label for="adminSongCompositor">Compositor</label>
              <input type="text" id="adminSongCompositor" />
            </div>
            <div class="field-group">
              <label for="adminSongGenero">G√©nero</label>
              <input type="text" id="adminSongGenero" />
            </div>

            <div class="field-group">
              <label for="adminSongImagen">Imagen (URL)</label>
              <input type="text" id="adminSongImagen" />
              <div class="input-inline" style="margin-top:4px;">
                <input type="file" id="adminSongImageFile" accept="image/*" />
                <button class="btn btn-secondary" id="btnUploadImage">üì§ Subir imagen</button>
              </div>
              <small class="admin-small">
                La imagen se sube a Supabase Storage y se rellena el URL autom√°ticamente.
              </small>
            </div>

            <div class="field-group">
              <label for="adminSongVideo">Video (URL)</label>
              <input type="text" id="adminSongVideo" />
            </div>
            <div class="field-group">
              <label for="adminSongTomadoDe">Tomado de</label>
              <input type="text" id="adminSongTomadoDe" />
            </div>
            <div class="field-group">
              <label for="adminSongHistoria">Historia</label>
              <textarea id="adminSongHistoria"></textarea>
            </div>
          </div>

          <!-- AUTORES -->
          <div id="adminFormAutores" style="display:none;">
            <div class="field-group">
              <label for="adminAutorNombreArtistico">Nombre art√≠stico</label>
              <input type="text" id="adminAutorNombreArtistico" />
            </div>
            <div class="field-group">
              <label for="adminAutorNombreReal">Nombre real</label>
              <input type="text" id="adminAutorNombreReal" />
            </div>
            <div class="field-group">
              <label for="adminAutorRol">Rol</label>
              <input type="text" id="adminAutorRol" placeholder="Int√©rprete, compositor, grupo..." />
            </div>
            <div class="field-group">
              <label for="adminAutorFoto">Foto (URL)</label>
              <input type="text" id="adminAutorFoto" />
            </div>
            <div class="field-group">
              <label for="adminAutorBiografia">Biograf√≠a</label>
              <textarea id="adminAutorBiografia"></textarea>
            </div>
            <div class="field-group">
              <label for="adminAutorExitos">√âxitos</label>
              <textarea id="adminAutorExitos" placeholder="Lista de canciones separadas por comas"></textarea>
            </div>
            <div class="field-group">
              <label for="adminAutorCuriosidades">Curiosidades</label>
              <textarea id="adminAutorCuriosidades"></textarea>
            </div>
            <div class="field-group">
              <label for="adminAutorTomadoDe">Tomado de</label>
              <input type="text" id="adminAutorTomadoDe" />
            </div>
          </div>

          <!-- CURIOSIDADES -->
          <div id="adminFormCuriosidades" style="display:none;">
            <div class="field-group">
              <label for="adminCurioTema">Tema</label>
              <input type="text" id="adminCurioTema" />
            </div>
            <div class="field-group">
              <label for="adminCurioDetalle">Detalle</label>
              <textarea id="adminCurioDetalle"></textarea>
            </div>
            <div class="field-group">
              <label for="adminCurioImagen">Imagen (URL)</label>
              <input type="text" id="adminCurioImagen" />
            </div>
            <div class="field-group">
              <label for="adminCurioTomadoDe">Tomado de</label>
              <input type="text" id="adminCurioTomadoDe" />
            </div>
          </div>

          <div class="status-message" id="adminStatus"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Overlay de login para Admin (se muestra solo cuando hace falta) -->
  <div id="adminOverlay" class="admin-overlay" style="display:none;">
    <div class="admin-dialog">
      <h2>ADMIN</h2>
      <p>Ingresa la contrase√±a de administraci√≥n para editar el contenido.</p>
      <div class="field-group">
        <label for="adminPasswordInput">Contrase√±a</label>
        <input type="password" id="adminPasswordInput" />
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" id="btnAdminLogin">Ingresar</button>
        <button class="btn btn-secondary" id="btnAdminCancel">Cancelar</button>
      </div>
      <div class="status-message status-error" id="adminLoginError" style="display:none;">
        Contrase√±a incorrecta.
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // üëâ CONFIGURA ESTO CON TUS DATOS
    const SUPABASE_URL = "https://ughnwwuputxmzzombrbg.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_pFU7leFyEi_01fTmji3pDw_NQdsOgVW";
    const STORAGE_BUCKET = "imagenes";   // nombre de tu bucket en Supabase Storage
    const ADMIN_PASSWORD = "historia2025";  // c√°mbialo por la contrase√±a que quieras

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let canciones = [];
    let autores = [];
    let curiosidades = [];

    let selectedSongId = null;
    let fullHistoryText = "";
    let historyExpanded = false;

    let songFilterType = "todos";
    let songFilterValue = "todos";
    let songSort = "az";
    let songSearch = "";

    let adminCurrentCategory = "canciones";
    let adminSelectedId = null;

    let adminUnlocked = localStorage.getItem("musica_admin_unlocked") === "1";

    const $ = (id) => document.getElementById(id);

    function setAdminStatus(msg, type = null) {
      const node = $("adminStatus");
      node.textContent = msg || "";
      node.className = "status-message";
      if (type === "ok") node.classList.add("status-ok");
      else if (type === "error") node.classList.add("status-error");
      else if (type === "muted") node.classList.add("status-muted");
    }

    function setAdminState(msg) {
      $("adminState").textContent = msg;
    }

    // --- CARGA DE DATOS DESDE SUPABASE ---
    async function loadData() {
      try {
        setAdminState("Conectando‚Ä¶");
        const { data: d1, error: e1 } = await supabase
          .from("canciones").select("*").order("titulo",{ascending:true});
        if (e1) throw e1;
        canciones = d1 || [];

        const { data: d2, error: e2 } = await supabase
          .from("autores").select("*").order("nombre_artistico",{ascending:true});
        if (e2) throw e2;
        autores = d2 || [];

        const { data: d3, error: e3 } = await supabase
          .from("curiosidades").select("*").order("tema",{ascending:true});
        if (e3) throw e3;
        curiosidades = d3 || [];

        $("countCanciones").textContent = canciones.length;
        $("countAutores").textContent = autores.length;
        $("countCuriosidades").textContent = curiosidades.length;

        renderSongFilters();
        renderSongList(true);
        renderAuthors();
        renderCuriosidades();
        renderAdminItems();
        setAdminState("Conectado");
        setAdminStatus("", "muted");
      } catch (err) {
        console.error(err);
        setAdminState("Error");
        setAdminStatus("Error al cargar datos desde Supabase.", "error");
      }
    }

    // --- UTILIDADES ---
    function safe(v) {
      const s = (v || "").toString().trim();
      return s.length ? s : "ND";
    }

    // --- CANCIONES: FILTROS + LISTA ---
    function renderSongFilters() {
      const typeSelect = $("songFilterType");
      const valueSelect = $("songFilterValue");

      typeSelect.value = songFilterType;

      let values = new Set();
      if (songFilterType === "genero") {
        canciones.forEach(c => c.genero && values.add(c.genero.trim()));
      } else if (songFilterType === "interprete") {
        canciones.forEach(c => c.interprete && values.add(c.interprete.trim()));
      }

      valueSelect.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "todos";
      optAll.textContent = "(todos)";
      valueSelect.appendChild(optAll);

      if (songFilterType !== "todos") {
        Array.from(values).sort((a,b)=>a.localeCompare(b,"es")).forEach(v=>{
          const op = document.createElement("option");
          op.value = v;
          op.textContent = v;
          valueSelect.appendChild(op);
        });
      }

      if ([...valueSelect.options].some(o=>o.value===songFilterValue)) {
        valueSelect.value = songFilterValue;
      } else {
        songFilterValue = "todos";
        valueSelect.value = "todos";
      }
    }

    function applySongFilters() {
      let list = [...canciones];

      if (songFilterType === "genero" && songFilterValue !== "todos") {
        list = list.filter(c => (c.genero || "").trim() === songFilterValue);
      } else if (songFilterType === "interprete" && songFilterValue !== "todos") {
        list = list.filter(c => (c.interprete || "").trim() === songFilterValue);
      }

      if (songSearch.trim()) {
        const q = songSearch.toLowerCase();
        list = list.filter(c => {
          const t = (c.titulo || "").toLowerCase();
          const i = (c.interprete || "").toLowerCase();
          return t.includes(q) || i.includes(q);
        });
      }

      list.sort((a,b)=>{
        const da = (a.titulo || "").toLowerCase();
        const db = (b.titulo || "").toLowerCase();
        return songSort === "az" ? da.localeCompare(db,"es") : db.localeCompare(da,"es");
      });

      return list;
    }

    function renderSongList(resetSelection = false) {
      const node = $("songList");
      node.innerHTML = "";
      const list = applySongFilters();

      if (!list.length) {
        const empty = document.createElement("div");
        empty.className = "list-item";
        empty.textContent = "No se encontraron canciones.";
        node.appendChild(empty);
        $("detailTitulo").textContent = "Selecciona una canci√≥n en la lista";
        $("detailInterprete").textContent = "ND";
        $("detailCompositor").textContent = "ND";
        $("detailGenero").innerHTML = '<span class="pill-genre">ND</span>';
        $("detailTomadoDe").textContent = "ND";
        $("detailVideo").textContent = "ND";
        $("detailHistoria").textContent = "ND";
        $("btnHistoriaToggle").style.display = "none";
        selectedSongId = null;
        return;
      }

      if (resetSelection) {
        selectedSongId = list[0].id;
      } else if (!selectedSongId || !list.some(c=>c.id===selectedSongId)) {
        selectedSongId = list[0].id;
      }

      list.forEach(c => {
        const item = document.createElement("div");
        item.className = "list-item";
        if (c.id === selectedSongId) item.classList.add("active");

        const title = document.createElement("div");
        title.className = "list-item-title";
        title.textContent = c.titulo || "Sin t√≠tulo";

        const meta = document.createElement("div");
        meta.className = "list-item-meta";
        const genero = c.genero && c.genero.trim() ? c.genero : "ND";
        meta.textContent = `${c.interprete || "ND"} ¬∑ ${genero}`;

        item.appendChild(title);
        item.appendChild(meta);

        item.addEventListener("click", () => {
          selectedSongId = c.id;
          showSongDetail(c);
          renderSongList(false);
        });

        node.appendChild(item);
      });

      const current = list.find(c=>c.id===selectedSongId) || list[0];
      showSongDetail(current);
    }

    function updateHistoryDisplay() {
      const node = $("detailHistoria");
      const btn = $("btnHistoriaToggle");
      const limit = 260;

      if (!fullHistoryText) {
        node.textContent = "ND";
        btn.style.display = "none";
        return;
      }

      btn.style.display = "inline-block";
      if (historyExpanded || fullHistoryText.length <= limit) {
        node.textContent = fullHistoryText;
        btn.textContent = "Ver menos";
      } else {
        node.textContent = fullHistoryText.slice(0,limit) + "‚Ä¶";
        btn.textContent = "Ver m√°s";
      }
    }

    function showSongDetail(song) {
      $("detailTitulo").textContent = safe(song.titulo);
      $("detailInterprete").textContent = safe(song.interprete);
      $("detailCompositor").textContent = safe(song.compositor);
      $("detailGenero").innerHTML = `<span class="pill-genre">${safe(song.genero)}</span>`;
      $("detailTomadoDe").textContent = safe(song.tomado_de);

      const video = (song.video || "").trim();
      const videoNode = $("detailVideo");
      if (video) {
        videoNode.innerHTML = `<a href="${video}" target="_blank" rel="noopener" class="video-link">Ver en YouTube</a>`;
      } else {
        videoNode.textContent = "ND";
      }

      fullHistoryText = (song.historia || "").trim();
      historyExpanded = false;
      updateHistoryDisplay();
    }

    // --- AUTORES ---
    function renderAuthors() {
      const listNode = $("authorList");
      listNode.innerHTML = "";
      const q = ($("authorSearch").value || "").toLowerCase().trim();

      let arr = [...autores];
      if (q) {
        arr = arr.filter(a => {
          const na = (a.nombre_artistico || "").toLowerCase();
          const nr = (a.nombre_real || "").toLowerCase();
          return na.includes(q) || nr.includes(q);
        });
      }

      if (!arr.length) {
        const item = document.createElement("div");
        item.className = "list-item";
        item.textContent = "No se encontraron autores.";
        listNode.appendChild(item);
        return;
      }

      arr.forEach(a => {
        const item = document.createElement("div");
        item.className = "list-item";
        const title = document.createElement("div");
        title.className = "list-item-title author-name";
        title.textContent = a.nombre_artistico || "ND";
        const meta = document.createElement("div");
        meta.className = "list-item-meta";
        const rol = a.rol || "ND";
        const real = a.nombre_real ? ` ¬∑ ${a.nombre_real}` : "";
        meta.textContent = `${rol}${real}`;
        item.appendChild(title);
        item.appendChild(meta);
        listNode.appendChild(item);
      });
    }

    // --- CURIOSIDADES ---
    function renderCuriosidades() {
      const listNode = $("curiosidadesList");
      listNode.innerHTML = "";
      if (!curiosidades.length) {
        const item = document.createElement("div");
        item.className = "list-item";
        item.textContent = "No hay curiosidades registradas.";
        listNode.appendChild(item);
        return;
      }
      curiosidades.forEach(c => {
        const item = document.createElement("div");
        item.className = "list-item";
        const title = document.createElement("div");
        title.className = "list-item-title curio-title";
        title.textContent = c.tema || "Sin tema";
        const meta = document.createElement("div");
        meta.className = "list-item-meta";
        meta.textContent = (c.detalle || "").trim() || "ND";
        item.appendChild(title);
        item.appendChild(meta);
        listNode.appendChild(item);
      });
    }

    // --- ADMIN: LISTA DE √çTEMS ---
    function clearAdminForm() {
      $("adminSongTitulo").value = "";
      $("adminSongInterprete").value = "";
      $("adminSongCompositor").value = "";
      $("adminSongGenero").value = "";
      $("adminSongImagen").value = "";
      $("adminSongVideo").value = "";
      $("adminSongTomadoDe").value = "";
      $("adminSongHistoria").value = "";

      $("adminAutorNombreArtistico").value = "";
      $("adminAutorNombreReal").value = "";
      $("adminAutorRol").value = "";
      $("adminAutorFoto").value = "";
      $("adminAutorBiografia").value = "";
      $("adminAutorExitos").value = "";
      $("adminAutorCuriosidades").value = "";
      $("adminAutorTomadoDe").value = "";

      $("adminCurioTema").value = "";
      $("adminCurioDetalle").value = "";
      $("adminCurioImagen").value = "";
      $("adminCurioTomadoDe").value = "";
    }

    function renderAdminItems() {
      const sel = $("adminItemSelect");
      sel.innerHTML = "";
      const q = ($("adminSearchItem").value || "").toLowerCase().trim();

      let arr = [];
      if (adminCurrentCategory === "canciones") arr = canciones;
      else if (adminCurrentCategory === "autores") arr = autores;
      else arr = curiosidades;

      arr = arr.filter(it => {
        let label = "";
        if (adminCurrentCategory === "canciones") label = it.titulo || "";
        else if (adminCurrentCategory === "autores") label = it.nombre_artistico || "";
        else label = it.tema || "";
        return label.toLowerCase().includes(q);
      });

      arr.forEach(it => {
        const opt = document.createElement("option");
        opt.value = it.id;
        if (adminCurrentCategory === "canciones") opt.textContent = it.titulo || "Sin t√≠tulo";
        else if (adminCurrentCategory === "autores") opt.textContent = it.nombre_artistico || "Sin nombre art√≠stico";
        else opt.textContent = it.tema || "Sin tema";
        sel.appendChild(opt);
      });

      if (arr.length) {
        if (!adminSelectedId || !arr.some(x=>x.id===adminSelectedId)) {
          adminSelectedId = arr[0].id;
        }
        sel.value = adminSelectedId;
        loadAdminForm();
      } else {
        adminSelectedId = null;
        clearAdminForm();
        setAdminInfo("No hay √≠tems en esta categor√≠a.");
      }
    }

    function setAdminInfo(msg) {
      $("adminInfo").textContent = msg;
    }

    function loadAdminForm() {
      if (!adminSelectedId) {
        clearAdminForm();
        setAdminInfo("Selecciona o crea un √≠tem para editarlo.");
        return;
      }
      let item = null;
      if (adminCurrentCategory === "canciones") {
        item = canciones.find(c=>c.id===adminSelectedId);
      } else if (adminCurrentCategory === "autores") {
        item = autores.find(a=>a.id===adminSelectedId);
      } else {
        item = curiosidades.find(c=>c.id===adminSelectedId);
      }
      if (!item) {
        clearAdminForm();
        setAdminInfo("No se encontr√≥ el √≠tem seleccionado.");
        return;
      }

      setAdminInfo("Editando √≠tem existente.");

      if (adminCurrentCategory === "canciones") {
        $("adminSongTitulo").value = item.titulo || "";
        $("adminSongInterprete").value = item.interprete || "";
        $("adminSongCompositor").value = item.compositor || "";
        $("adminSongGenero").value = item.genero || "";
        $("adminSongImagen").value = item.imagen || "";
        $("adminSongVideo").value = item.video || "";
        $("adminSongTomadoDe").value = item.tomado_de || "";
        $("adminSongHistoria").value = item.historia || "";
      } else if (adminCurrentCategory === "autores") {
        $("adminAutorNombreArtistico").value = item.nombre_artistico || "";
        $("adminAutorNombreReal").value = item.nombre_real || "";
        $("adminAutorRol").value = item.rol || "";
        $("adminAutorFoto").value = item.foto || "";
        $("adminAutorBiografia").value = item.biografia || "";
        $("adminAutorExitos").value = item.exitos || "";
        $("adminAutorCuriosidades").value = item.curiosidades || "";
        $("adminAutorTomadoDe").value = item.tomado_de || "";
      } else {
        $("adminCurioTema").value = item.tema || "";
        $("adminCurioDetalle").value = item.detalle || "";
        $("adminCurioImagen").value = item.imagen || "";
        $("adminCurioTomadoDe").value = item.tomado_de || "";
      }
    }

    function nuevoAdminItem() {
      adminSelectedId = null;
      $("adminItemSelect").value = "";
      clearAdminForm();
      setAdminInfo("Nuevo √≠tem listo para guardar.");
      setAdminStatus("", "muted");
    }

    async function guardarAdmin() {
      let table = "";
      let payload = {};

      if (adminCurrentCategory === "canciones") {
        table = "canciones";
        payload = {
          titulo: $("adminSongTitulo").value.trim(),
          interprete: $("adminSongInterprete").value.trim(),
          compositor: $("adminSongCompositor").value.trim(),
          genero: $("adminSongGenero").value.trim(),
          imagen: $("adminSongImagen").value.trim(),
          video: $("adminSongVideo").value.trim(),
          tomado_de: $("adminSongTomadoDe").value.trim(),
          historia: $("adminSongHistoria").value.trim(),
        };
      } else if (adminCurrentCategory === "autores") {
        table = "autores";
        payload = {
          nombre_artistico: $("adminAutorNombreArtistico").value.trim(),
          nombre_real: $("adminAutorNombreReal").value.trim(),
          rol: $("adminAutorRol").value.trim(),
          foto: $("adminAutorFoto").value.trim(),
          biografia: $("adminAutorBiografia").value.trim(),
          exitos: $("adminAutorExitos").value.trim(),
          curiosidades: $("adminAutorCuriosidades").value.trim(),
          tomado_de: $("adminAutorTomadoDe").value.trim(),
        };
      } else {
        table = "curiosidades";
        payload = {
          tema: $("adminCurioTema").value.trim(),
          detalle: $("adminCurioDetalle").value.trim(),
          imagen: $("adminCurioImagen").value.trim(),
          tomado_de: $("adminCurioTomadoDe").value.trim(),
        };
      }

      try {
        if (adminSelectedId) {
          const { error } = await supabase.from(table)
            .update(payload).eq("id", adminSelectedId);
          if (error) throw error;
        } else {
          const { data, error } = await supabase.from(table)
            .insert(payload).select().single();
          if (error) throw error;
          adminSelectedId = data.id;
        }
        setAdminStatus("Cambios guardados correctamente.", "ok");
        await loadData();
      } catch (e) {
        console.error(e);
        setAdminStatus("Error al guardar el √≠tem.", "error");
      }
    }

    async function eliminarAdmin() {
      if (!adminSelectedId) {
        setAdminStatus("No hay √≠tem seleccionado para eliminar.", "error");
        return;
      }
      if (!confirm("¬øEliminar este √≠tem?")) return;

      let table = adminCurrentCategory === "canciones"
        ? "canciones"
        : adminCurrentCategory === "autores"
          ? "autores"
          : "curiosidades";

      try {
        const { error } = await supabase.from(table)
          .delete().eq("id", adminSelectedId);
        if (error) throw error;

        adminSelectedId = null;
        setAdminStatus("√çtem eliminado correctamente.", "ok");
        await loadData();
      } catch (e) {
        console.error(e);
        setAdminStatus("Error al eliminar el √≠tem.", "error");
      }
    }

    // --- IMPORTAR CSV DESDE ADMIN ---
    function parseCsv(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
      if (!lines.length) return [];
      const headers = lines[0].split(",").map(h=>h.trim());
      const rows = [];
      for (let i=1;i<lines.length;i++) {
        const line = lines[i];
        if (!line.trim()) continue;
        const parts = [];
        let current = "";
        let inQuotes = false;
        for (let j=0;j<line.length;j++) {
          const ch = line[j];
          if (ch === '"' ) {
            inQuotes = !inQuotes;
          } else if (ch === "," && !inQuotes) {
            parts.push(current);
            current = "";
          } else {
            current += ch;
          }
        }
        parts.push(current);
        const obj = {};
        headers.forEach((h,idx)=>{ obj[h] = (parts[idx] || "").trim().replace(/^"|"$/g,""); });
        rows.push(obj);
      }
      return rows;
    }

    async function importarCsvParaCategoria(file) {
      if (!file) return;
      const cat = adminCurrentCategory;
      setAdminStatus(`Leyendo CSV para la categor√≠a ${cat}‚Ä¶`,"muted");

      try {
        const text = await file.text();
        let rows = parseCsv(text);
        if (!rows.length) {
          setAdminStatus("El CSV no contiene filas.", "error");
          return;
        }
        let table = "";
        if (cat === "canciones") {
          table = "canciones";
          rows = rows.map(r => ({
            titulo: r.titulo || r.Cancion || r.Canci√≥n || "",
            interprete: r.interprete || r.Interprete || r.Int√©rprete || "",
            compositor: r.compositor || r.Compositor || "",
            genero: r.genero || r.Genero || r.G√©nero || "",
            imagen: r.imagen || r.Imagen || "",
            video: r.video || r.Video || r.video_url || "",
            tomado_de: r.tomado_de || r["Tomado de"] || "",
            historia: r.historia || r.Historia || "",
          }));
        } else if (cat === "autores") {
          table = "autores";
          rows = rows.map(r => ({
            nombre_artistico: r.nombre_artistico || r["Nombre art√≠stico"] || "",
            nombre_real: r.nombre_real || r["Nombre real"] || "",
            rol: r.rol || r.Rol || "",
            foto: r.foto || r.Foto || "",
            biografia: r.biografia || r.Biografia || r.Biograf√≠a || "",
            exitos: r.exitos || r.Exitos || r.√âxitos || "",
            curiosidades: r.curiosidades || r.Curiosidades || "",
            tomado_de: r.tomado_de || r["Tomado de"] || "",
          }));
        } else {
          table = "curiosidades";
          rows = rows.map(r => ({
            tema: r.tema || r.Tema || "",
            detalle: r.detalle || r.Detalle || "",
            imagen: r.imagen || r.Imagen || "",
            tomado_de: r.tomado_de || r["Tomado de"] || "",
          }));
        }
        rows = rows.filter(r =>
          Object.values(r).some(v => (v || "").trim() !== "")
        );
        if (!rows.length) {
          setAdminStatus("No se encontraron filas v√°lidas en el CSV.", "error");
          return;
        }
        setAdminStatus(`Importando ${rows.length} registros en ${table}‚Ä¶`,"muted");
        const chunkSize = 50;
        for (let i=0;i<rows.length;i+=chunkSize) {
          const chunk = rows.slice(i,i+chunkSize);
          const { error } = await supabase.from(table).insert(chunk);
          if (error) {
            console.error(error);
            setAdminStatus("Error al importar algunos registros.", "error");
            return;
          }
        }
        setAdminStatus(`Importaci√≥n completada: ${rows.length} registros.`, "ok");
        await loadData();
      } catch (e) {
        console.error(e);
        setAdminStatus("Error al procesar el CSV.", "error");
      }
    }

    // --- SUBIR IMAGEN A SUPABASE STORAGE ---
    async function uploadImageFile() {
      const input = $("adminSongImageFile");
      const file = input.files && input.files[0];
      if (!file) {
        setAdminStatus("Selecciona un archivo de imagen primero.", "error");
        return;
      }
      try {
        const ext = file.name.split(".").pop();
        const fileName = `${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`;
        const path = `canciones/${fileName}`;
        const { error } = await supabase.storage
          .from(STORAGE_BUCKET)
          .upload(path, file);
        if (error) throw error;

        const { data } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(path);
        const url = data.publicUrl;
        $("adminSongImagen").value = url;
        setAdminStatus("Imagen subida correctamente.", "ok");
      } catch (e) {
        console.error(e);
        setAdminStatus("Error al subir la imagen. Revisa el bucket en Supabase.", "error");
      }
    }

    // --- LOGIN ADMIN ---
    function showAdminOverlay(show) {
      $("adminOverlay").style.display = show ? "flex" : "none";
      $("adminLoginError").style.display = "none";
      $("adminPasswordInput").value = "";
    }

    function requireAdminPassword() {
      if (adminUnlocked) return true;
      showAdminOverlay(true);
      return false;
    }

    function handleAdminLogin() {
      const pwd = $("adminPasswordInput").value;
      if (pwd === ADMIN_PASSWORD) {
        adminUnlocked = true;
        localStorage.setItem("musica_admin_unlocked","1");
        showAdminOverlay(false);
        return true;
      }
      $("adminLoginError").style.display = "block";
      return false;
    }

    // --- TABS ---
    function initTabs() {
      const tabs = document.querySelectorAll(".tab");
      tabs.forEach(t => {
        t.addEventListener("click", () => {
          const id = t.dataset.tab;

          if (id === "admin") {
            if (!adminUnlocked) {
              if (!requireAdminPassword()) return;
            }
          }

          tabs.forEach(x => x.classList.remove("active"));
          t.classList.add("active");

          ["canciones","autores","curiosidades","admin"].forEach(tabId=>{
            $("tab-"+tabId).style.display = tabId === id ? "block" : "none";
          });

          if (id === "canciones") {
            songSearch = "";
            $("songSearch").value = "";
            renderSongFilters();
            renderSongList(true);
          } else if (id === "autores") {
            $("authorSearch").value = "";
            renderAuthors();
          }
        });
      });
    }

    // --- EVENTOS ---
    function initEvents() {
      $("songFilterType").addEventListener("change", e => {
        songFilterType = e.target.value;
        songFilterValue = "todos";
        songSearch = "";
        $("songSearch").value = "";
        renderSongFilters();
        renderSongList(true);
      });
      $("songFilterValue").addEventListener("change", e => {
        songFilterValue = e.target.value;
        renderSongList(true);
      });
      $("songSort").addEventListener("change", e => {
        songSort = e.target.value;
        renderSongList(true);
      });
      $("songSearch").addEventListener("input", e => {
        songSearch = e.target.value;
        renderSongList(false);
      });
      $("btnHistoriaToggle").addEventListener("click", () => {
        historyExpanded = !historyExpanded;
        updateHistoryDisplay();
      });

      $("authorSearch").addEventListener("input", renderAuthors);

      $("adminCategory").addEventListener("change", e => {
        adminCurrentCategory = e.target.value;
        adminSelectedId = null;
        $("adminFormCanciones").style.display =
          adminCurrentCategory === "canciones" ? "block" : "none";
        $("adminFormAutores").style.display =
          adminCurrentCategory === "autores" ? "block" : "none";
        $("adminFormCuriosidades").style.display =
          adminCurrentCategory === "curiosidades" ? "block" : "none";
        $("adminSearchItem").value = "";
        clearAdminForm();
        renderAdminItems();
        setAdminStatus("", "muted");
      });

      $("adminSearchItem").addEventListener("input", renderAdminItems);
      $("adminItemSelect").addEventListener("change", e => {
        adminSelectedId = e.target.value || null;
        loadAdminForm();
      });

      $("btnNuevoItem").addEventListener("click", nuevoAdminItem);
      $("btnGuardar").addEventListener("click", guardarAdmin);
      $("btnEliminar").addEventListener("click", eliminarAdmin);
      $("btnRefrescar").addEventListener("click", loadData);

      $("btnImportCsv").addEventListener("click", () => {
        const input = $("csvFileInput");
        input.value = "";
        input.click();
      });
      $("csvFileInput").addEventListener("change", e => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        importarCsvParaCategoria(file);
      });

      $("btnUploadImage").addEventListener("click", uploadImageFile);

      $("btnAdminLogin").addEventListener("click", handleAdminLogin);
      $("btnAdminCancel").addEventListener("click", () => {
        showAdminOverlay(false);
        const tabs = document.querySelectorAll(".tab");
        tabs.forEach(t => t.classList.remove("active"));
        document.querySelector('.tab[data-tab="canciones"]').classList.add("active");
        ["canciones","autores","curiosidades","admin"].forEach(tabId=>{
          $("tab-"+tabId).style.display = tabId === "canciones" ? "block" : "none";
        });
      });
      $("adminPasswordInput").addEventListener("keydown", e => {
        if (e.key === "Enter") handleAdminLogin();
      });
    }

    // --- INICIO ---
    initTabs();
    initEvents();
    loadData();
  </script>
</body>
</html>