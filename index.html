<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>M√∫sica e Historias</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050611;
      --bg-alt: #101321;
      --accent: #ff9a3c;
      --accent-soft: #ffbd6b;
      --accent-danger: #ff4d6a;
      --text: #f7f7ff;
      --text-muted: #a5a8c1;
      --card: #181a2b;
      --border: #30334a;
      --radius: 14px;
      --shadow-soft: 0 18px 40px rgba(0,0,0,0.45);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1a1d3a, #050611 55%);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      padding: 1.5rem 1.5rem 0.5rem;
    }

    .title {
      font-size: 1.9rem;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    .subtitle {
      color: var(--text-muted);
      margin-top: 0.25rem;
      font-size: 0.95rem;
    }

    main {
      padding: 0 1.2rem 2.5rem;
      max-width: 1100px;
      margin: 0 auto;
    }

    .tabs {
      display: flex;
      gap: 0.6rem;
      margin: 1rem 0 1.2rem;
      flex-wrap: wrap;
    }

    .tab-btn {
      border-radius: 999px;
      padding: 0.4rem 0.9rem;
      border: 1px solid transparent;
      background: rgba(255,255,255,0.03);
      color: var(--text-muted);
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .tab-btn span.badge {
      background: rgba(0,0,0,0.4);
      border-radius: 999px;
      padding: 0 0.45rem;
      font-size: 0.7rem;
    }

    .tab-btn.active {
      background: linear-gradient(120deg, #ff9a3c, #ff4d6a);
      border-color: #ffb36a;
      color: #1b0b07;
      font-weight: 600;
    }

    .section-card {
      background: radial-gradient(circle at top left, #262949, #121426);
      border-radius: 22px;
      box-shadow: var(--shadow-soft);
      padding: 1.3rem 1.2rem 1.6rem;
      border: 1px solid rgba(255,255,255,0.04);
      margin-bottom: 1.5rem;
    }

    h2 {
      margin-top: 0;
      font-size: 1.25rem;
      letter-spacing: 0.05em;
    }

    h3 {
      font-size: 1.05rem;
      margin-top: 1rem;
      margin-bottom: 0.6rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-bottom: 0.9rem;
      align-items: flex-end;
    }

    label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      display: block;
      margin-bottom: 0.15rem;
    }

    select, input[type="text"], textarea {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(3,4,12,0.7);
      color: var(--text);
      padding: 0.45rem 0.85rem;
      font-size: 0.9rem;
      outline: none;
    }

    textarea {
      border-radius: 12px;
      min-height: 90px;
      resize: vertical;
    }

    select {
      appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, var(--text-muted) 50%),
        linear-gradient(135deg, var(--text-muted) 50%, transparent 50%);
      background-position:
        calc(100% - 14px) calc(50% - 2px),
        calc(100% - 9px) calc(50% - 2px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      padding-right: 26px;
    }

    .input-with-icon {
      position: relative;
    }

    .input-with-icon input {
      padding-left: 2rem;
    }

    .input-with-icon span.icon {
      position: absolute;
      left: 0.7rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .list {
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.04);
      background: rgba(3,4,12,0.6);
      max-height: 420px;
      overflow-y: auto;
    }

    .list-item {
      padding: 0.7rem 0.9rem;
      border-bottom: 1px solid rgba(255,255,255,0.03);
      cursor: pointer;
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .list-item:hover {
      background: rgba(255,255,255,0.03);
    }

    .list-item-title {
      font-size: 0.95rem;
      font-weight: 500;
    }

    .list-item-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .song-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
      gap: 1.1rem;
    }

    @media (max-width: 820px) {
      .song-layout {
        grid-template-columns: 1fr;
      }
    }

    .song-detail {
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.06);
      background: radial-gradient(circle at top, #262949, #151729);
      padding: 0.9rem 1rem;
    }

    .song-meta {
      font-size: 0.85rem;
      margin-bottom: 0.4rem;
      color: var(--text-muted);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 0.7rem;
      margin-right: 0.35rem;
      margin-top: 0.15rem;
    }

    .pill.genre {
      border-color: var(--accent-soft);
      color: var(--accent-soft);
    }

    .history-text {
      margin-top: 0.45rem;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .media-preview {
      margin-top: 0.7rem;
      font-size: 0.8rem;
    }

    .media-preview a {
      color: var(--accent-soft);
      text-decoration: none;
    }

    .media-preview a:hover {
      text-decoration: underline;
    }

    .admin-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
      gap: 1.1rem;
    }

    @media (max-width: 840px) {
      .admin-layout {
        grid-template-columns: 1fr;
      }
    }

    .admin-box {
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(3,4,12,0.7);
      padding: 0.9rem 1rem 1rem;
    }

    .small-muted {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .save-counter {
      margin-top: 0.25rem;
      font-size: 0.85rem;
    }

    .save-counter span.number {
      color: var(--accent-danger);
      font-weight: 600;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.7rem;
    }

    .btn {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      padding: 0.4rem 0.95rem;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
    }

    .btn-primary {
      background: linear-gradient(120deg, #ff9a3c, #ff4d6a);
      color: #1b0b07;
      font-weight: 600;
    }

    .btn-secondary {
      background: rgba(255,255,255,0.08);
      color: var(--text);
    }

    .btn-danger {
      background: rgba(255,77,106,0.14);
      color: var(--accent-danger);
    }

    .status-message {
      margin-top: 0.4rem;
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .status-message.ok {
      color: #7df5c6;
    }

    .status-message.err {
      color: var(--accent-danger);
    }

    .field-grid {
      display: grid;
      gap: 0.55rem;
    }

    .field-grid.two {
      grid-template-columns: repeat(2, minmax(0,1fr));
    }

    @media (max-width: 640px) {
      .field-grid.two {
        grid-template-columns: 1fr;
      }
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin-top: 0.3rem;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      padding: 0.1rem 0.55rem;
      font-size: 0.7rem;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <header>
    <div class="title">M√∫sica e Historias</div>
    <div class="subtitle">
      Canciones con historia, cantantes y curiosidades de la m√∫sica latina.
    </div>
  </header>

  <main>
    <div class="tabs">
      <button class="tab-btn active" data-section="canciones-section">
        Canciones <span class="badge" id="badge-canciones">0</span>
      </button>
      <button class="tab-btn" data-section="autores-section">
        Cantantes / Autores <span class="badge" id="badge-autores">0</span>
      </button>
      <button class="tab-btn" data-section="curiosidades-section">
        Curiosidades <span class="badge" id="badge-curiosidades">0</span>
      </button>
      <button class="tab-btn" data-section="admin-section">
        Admin
      </button>
    </div>

    <!-- CANCIONES -->
    <section id="canciones-section" class="section-card">
      <h2>Canciones</h2>
      <div class="song-layout">
        <div>
          <div class="filters-row">
            <div style="flex:1 1 110px; min-width: 110px;">
              <label for="filterTipo">Filtrar por</label>
              <select id="filterTipo">
                <option value="todos">Todos</option>
                <option value="genero">G√©nero</option>
                <option value="interprete">Int√©rprete</option>
              </select>
            </div>
            <div style="flex:1 1 150px; min-width: 150px;">
              <label for="filterValor">(opciones)</label>
              <select id="filterValor">
                <option value="todos">(todos)</option>
              </select>
            </div>
            <div style="flex:1 1 130px; min-width: 130px;">
              <label for="orderCanciones">Ordenar por</label>
              <select id="orderCanciones">
                <option value="asc">A ‚Üí Z</option>
                <option value="desc">Z ‚Üí A</option>
              </select>
            </div>
          </div>
          <div class="filters-row">
            <div style="flex:1 1 100%;">
              <label for="searchCanciones">Buscar canci√≥n</label>
              <div class="input-with-icon">
                <span class="icon">üîç</span>
                <input id="searchCanciones" type="text" placeholder="Escribe parte del t√≠tulo o del int√©rprete..." />
              </div>
            </div>
          </div>

          <div class="list" id="listaCanciones"></div>
        </div>
        <div>
          <div class="song-detail" id="detalleCancion">
            <div class="song-meta">Selecciona una canci√≥n de la lista para ver su historia.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- AUTORES -->
    <section id="autores-section" class="section-card" style="display:none;">
      <h2>Cantantes y Autores</h2>
      <div class="song-layout">
        <div>
          <div class="filters-row">
            <div style="flex:1 1 100%;">
              <label for="searchAutores">Buscar artista</label>
              <div class="input-with-icon">
                <span class="icon">üîç</span>
                <input id="searchAutores" type="text" placeholder="Nombre art√≠stico o real..." />
              </div>
            </div>
          </div>
          <div class="list" id="listaAutores"></div>
        </div>
        <div>
          <div class="song-detail" id="detalleAutor">
            <div class="song-meta">Selecciona un cantante o autor para ver su biograf√≠a.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- CURIOSIDADES -->
    <section id="curiosidades-section" class="section-card" style="display:none;">
      <h2>Curiosidades</h2>
      <div class="song-layout">
        <div>
          <div class="filters-row">
            <div style="flex:1 1 100%;">
              <label for="searchCuriosidades">Buscar curiosidad</label>
              <div class="input-with-icon">
                <span class="icon">üîç</span>
                <input id="searchCuriosidades" type="text" placeholder="Palabras clave del tema..." />
              </div>
            </div>
          </div>
          <div class="list" id="listaCuriosidades"></div>
        </div>
        <div>
          <div class="song-detail" id="detalleCuriosidad">
            <div class="song-meta">Selecciona una curiosidad para ver el detalle.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="admin-section" class="section-card" style="display:none;">
      <h2>Administraci√≥n</h2>
      <p class="small-muted">
        Edici√≥n conectada a la base de datos Supabase. Los cambios se guardan directamente en la nube.
      </p>
      <div class="save-counter">
        <span class="number" id="adminSaveCount">0</span> cambios guardados en esta sesi√≥n.
      </div>

      <div class="admin-layout" style="margin-top:0.9rem;">
        <div class="admin-box">
          <div class="field-grid">
            <div>
              <label for="adminCategory">Categor√≠a</label>
              <select id="adminCategory">
                <option value="canciones">Canciones</option>
                <option value="autores">Cantantes / Autores</option>
                <option value="curiosidades">Curiosidades</option>
              </select>
            </div>
            <div>
              <label for="adminSearch">Buscar √≠tem</label>
              <div class="input-with-icon">
                <span class="icon">üîç</span>
                <input id="adminSearch" type="text" placeholder="Escribe parte del t√≠tulo o nombre..." />
              </div>
            </div>
            <div>
              <label for="adminItem">√çtem</label>
              <select id="adminItem"></select>
            </div>
          </div>

          <div class="btn-row" style="margin-top:0.9rem;">
            <button class="btn btn-primary" id="btnNuevoItem">Agregar nuevo √≠tem</button>
          </div>

          <div class="status-message" id="adminInfo">
            Selecciona o crea un √≠tem para editarlo.
          </div>
        </div>

        <div class="admin-box">
          <form id="adminForm">
            <!-- Campos din√°micos seg√∫n categor√≠a -->
          </form>
          <div class="btn-row">
            <button type="button" class="btn btn-primary" id="btnGuardar">
              üíæ Guardar
            </button>
            <button type="button" class="btn btn-secondary" id="btnRefrescar">
              üîÑ Recargar datos
            </button>
            <button type="button" class="btn btn-danger" id="btnEliminar">
              üóë Eliminar √≠tem
            </button>
          </div>
          <div class="status-message" id="adminStatus"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- SCRIPT PRINCIPAL: Supabase + l√≥gica -->
  <script type="module">
    // üëâ 1. IMPORTAR SUPABASE
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // üëâ 2. RELLENA ESTOS DOS VALORES CON LOS TUYOS
    const SUPABASE_URL = "https://ughnwwuputxmzzombrbg.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_pFU7leFyEi_01fTmji3pDw_NQdsOgVW";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Estado en memoria
    let canciones = [];
    let autores = [];
    let curiosidades = [];

    let adminCurrentCategory = "canciones";
    let adminCurrentId = null;
    let adminSaveCount = 0;

    // Utilidad para crear elementos
    function el(tag, attrs = {}, children = []) {
      const node = document.createElement(tag);
      Object.entries(attrs).forEach(([k, v]) => {
        if (k === "class") node.className = v;
        else if (k === "html") node.innerHTML = v;
        else node.setAttribute(k, v);
      });
      (Array.isArray(children) ? children : [children]).forEach(ch => {
        if (typeof ch === "string") node.appendChild(document.createTextNode(ch));
        else if (ch) node.appendChild(ch);
      });
      return node;
    }

    function setAdminStatus(msg, ok = null) {
      const s = document.getElementById("adminStatus");
      s.textContent = msg || "";
      s.classList.remove("ok", "err");
      if (ok === true) s.classList.add("ok");
      else if (ok === false) s.classList.add("err");
    }

    function incrementSaveCounter() {
      adminSaveCount += 1;
      document.getElementById("adminSaveCount").textContent = adminSaveCount;
    }

    // ===========================================
    // CARGA INICIAL DESDE SUPABASE
    // ===========================================
    async function loadData() {
      setAdminStatus("Cargando datos desde Supabase...");
      try {
        const [{ data: c, error: errC }, { data: a, error: errA }, { data: u, error: errU }] =
          await Promise.all([
            supabase.from("canciones").select("*").order("titulo", { ascending: true }),
            supabase.from("autores").select("*").order("nombre_artistico", { ascending: true }),
            supabase.from("curiosidades").select("*").order("tema", { ascending: true })
          ]);

        if (errC || errA || errU) {
          console.error(errC || errA || errU);
          setAdminStatus("Error al cargar datos desde Supabase.", false);
          return;
        }

        canciones = c || [];
        autores = a || [];
        curiosidades = u || [];

        document.getElementById("badge-canciones").textContent = canciones.length;
        document.getElementById("badge-autores").textContent = autores.length;
        document.getElementById("badge-curiosidades").textContent = curiosidades.length;

        renderCancionesList();
        renderAutoresList();
        renderCuriosidadesList();
        initAdminSelectors();

        setAdminStatus("Datos cargados correctamente desde Supabase.", true);
      } catch (e) {
        console.error(e);
        setAdminStatus("Error inesperado al cargar datos.", false);
      }
    }

    // ===========================================
    // RENDER CANCIONES
    // ===========================================
    function getCancionesFiltradasOrdenadas() {
      const tipo = document.getElementById("filterTipo").value;
      const valor = document.getElementById("filterValor").value;
      const orden = document.getElementById("orderCanciones").value;
      const busq = document.getElementById("searchCanciones").value.trim().toLowerCase();

      let lista = [...canciones];

      if (tipo === "genero" && valor !== "todos") {
        lista = lista.filter(c => (c.genero || "").toLowerCase() === valor.toLowerCase());
      } else if (tipo === "interprete" && valor !== "todos") {
        lista = lista.filter(c => (c.interprete || "").toLowerCase() === valor.toLowerCase());
      }

      if (busq) {
        lista = lista.filter(c =>
          (c.titulo || "").toLowerCase().includes(busq) ||
          (c.interprete || "").toLowerCase().includes(busq)
        );
      }

      lista.sort((a, b) => {
        const ta = (a.titulo || "").toLowerCase();
        const tb = (b.titulo || "").toLowerCase();
        if (orden === "asc") return ta.localeCompare(tb);
        return tb.localeCompare(ta);
      });

      return lista;
    }

    function updateFilterOptions() {
      const tipo = document.getElementById("filterTipo").value;
      const selectValor = document.getElementById("filterValor");
      selectValor.innerHTML = "";
      selectValor.appendChild(el("option", { value: "todos" }, "(todos)"));

      if (tipo === "genero") {
        const setG = new Set(
          canciones
            .map(c => c.genero || "")
            .filter(g => g.trim() !== "")
        );
        Array.from(setG)
          .sort((a, b) => a.localeCompare(b))
          .forEach(g => selectValor.appendChild(el("option", { value: g }, g)));
      } else if (tipo === "interprete") {
        const setI = new Set(
          canciones
            .map(c => c.interprete || "")
            .filter(i => i.trim() !== "")
        );
        Array.from(setI)
          .sort((a, b) => a.localeCompare(b))
          .forEach(i => selectValor.appendChild(el("option", { value: i }, i)));
      }
    }

    function renderCancionesList() {
      updateFilterOptions();
      const cont = document.getElementById("listaCanciones");
      cont.innerHTML = "";
      const lista = getCancionesFiltradasOrdenadas();
      if (!lista.length) {
        cont.appendChild(el("div", { class: "list-item" }, "No hay canciones a√∫n."));
        return;
      }
      lista.forEach(c => {
        const item = el("div", { class: "list-item", "data-id": c.id }, [
          el("div", { class: "list-item-title" }, c.titulo || "(sin t√≠tulo)"),
          el("div", { class: "list-item-subtitle" }, `${c.interprete || "Int√©rprete desconocido"} ¬∑ ${c.genero || "G√©nero N/D"}`)
        ]);
        item.addEventListener("click", () => showCancionDetalle(c.id));
        cont.appendChild(item);
      });
    }

    function showCancionDetalle(id) {
      const c = canciones.find(x => x.id === id);
      const box = document.getElementById("detalleCancion");
      if (!c) {
        box.innerHTML = "<div class='song-meta'>Canci√≥n no encontrada.</div>";
        return;
      }

      box.innerHTML = "";
      box.appendChild(el("div", { class: "song-meta" }, [
        el("strong", {}, c.titulo || "(sin t√≠tulo)")
      ]));

      const chips = el("div", { class: "chips" });
      if (c.interprete) chips.appendChild(el("span", { class: "chip" }, `Int√©rprete: ${c.interprete}`));
      if (c.compositor) chips.appendChild(el("span", { class: "chip" }, `Compositor: ${c.compositor}`));
      if (c.genero) chips.appendChild(el("span", { class: "chip" }, `G√©nero: ${c.genero}`));
      box.appendChild(chips);

      if (c.historia) {
        box.appendChild(el("div", { class: "history-text" }, c.historia));
      }

      if (c.tomado_de) {
        box.appendChild(el("div", { class: "song-meta" }, `Tomado de: ${c.tomado_de}`));
      }

      const media = el("div", { class: "media-preview" });
      if (c.imagen) {
        media.appendChild(el("div", {}, `Imagen: ${c.imagen}`));
      }
      if (c.video) {
        const link = el("a", { href: c.video, target: "_blank" }, "Ver video");
        media.appendChild(link);
      }
      if (media.childNodes.length > 0) {
        box.appendChild(media);
      }
    }

    // ===========================================
    // RENDER AUTORES
    // ===========================================
    function renderAutoresList() {
      const cont = document.getElementById("listaAutores");
      const busq = document.getElementById("searchAutores").value.trim().toLowerCase();
      cont.innerHTML = "";

      let lista = [...autores];
      if (busq) {
        lista = lista.filter(a =>
          (a.nombre_artistico || "").toLowerCase().includes(busq) ||
          (a.nombre_real || "").toLowerCase().includes(busq)
        );
      }

      if (!lista.length) {
        cont.appendChild(el("div", { class: "list-item" }, "No hay autores a√∫n."));
        return;
      }

      lista.forEach(a => {
        const item = el("div", { class: "list-item", "data-id": a.id }, [
          el("div", { class: "list-item-title" }, a.nombre_artistico || "(sin nombre art√≠stico)"),
          el("div", { class: "list-item-subtitle" }, a.nombre_real || "Nombre real N/D")
        ]);
        item.addEventListener("click", () => showAutorDetalle(a.id));
        cont.appendChild(item);
      });
    }

    function showAutorDetalle(id) {
      const a = autores.find(x => x.id === id);
      const box = document.getElementById("detalleAutor");
      if (!a) {
        box.innerHTML = "<div class='song-meta'>Autor no encontrado.</div>";
        return;
      }

      box.innerHTML = "";
      box.appendChild(el("div", { class: "song-meta" }, [
        el("strong", {}, a.nombre_artistico || "(sin nombre art√≠stico)")
      ]));

      const chips = el("div", { class: "chips" });
      if (a.nombre_real) chips.appendChild(el("span", { class: "chip" }, `Nombre real: ${a.nombre_real}`));
      if (a.rol) chips.appendChild(el("span", { class: "chip" }, `Rol: ${a.rol}`));
      box.appendChild(chips);

      if (a.biografia) {
        box.appendChild(el("div", { class: "history-text" }, a.biografia));
      }
      if (a.exitos) {
        box.appendChild(el("div", { class: "song-meta" }, `√âxitos: ${a.exitos}`));
      }
      if (a.curiosidades) {
        box.appendChild(el("div", { class: "song-meta" }, `Curiosidades: ${a.curiosidades}`));
      }
      if (a.tomado_de) {
        box.appendChild(el("div", { class: "song-meta" }, `Tomado de: ${a.tomado_de}`));
      }
    }

    // ===========================================
    // RENDER CURIOSIDADES
    // ===========================================
    function renderCuriosidadesList() {
      const cont = document.getElementById("listaCuriosidades");
      const busq = document.getElementById("searchCuriosidades").value.trim().toLowerCase();
      cont.innerHTML = "";

      let lista = [...curiosidades];
      if (busq) {
        lista = lista.filter(c =>
          (c.tema || "").toLowerCase().includes(busq) ||
          (c.detalle || "").toLowerCase().includes(busq)
        );
      }

      if (!lista.length) {
        cont.appendChild(el("div", { class: "list-item" }, "No hay curiosidades a√∫n."));
        return;
      }

      lista.forEach(c => {
        const item = el("div", { class: "list-item", "data-id": c.id }, [
          el("div", { class: "list-item-title" }, c.tema || "(sin tema)"),
          el("div", { class: "list-item-subtitle" }, (c.tomado_de || "").slice(0, 60))
        ]);
        item.addEventListener("click", () => showCuriosidadDetalle(c.id));
        cont.appendChild(item);
      });
    }

    function showCuriosidadDetalle(id) {
      const c = curiosidades.find(x => x.id === id);
      const box = document.getElementById("detalleCuriosidad");
      if (!c) {
        box.innerHTML = "<div class='song-meta'>Curiosidad no encontrada.</div>";
        return;
      }

      box.innerHTML = "";
      box.appendChild(el("div", { class: "song-meta" }, [
        el("strong", {}, c.tema || "(sin tema)")
      ]));

      if (c.detalle) {
        box.appendChild(el("div", { class: "history-text" }, c.detalle));
      }
      if (c.tomado_de) {
        box.appendChild(el("div", { class: "song-meta" }, `Tomado de: ${c.tomado_de}`));
      }
      if (c.imagen) {
        box.appendChild(el("div", { class: "media-preview" }, `Imagen: ${c.imagen}`));
      }
    }

    // ===========================================
    // ADMIN: SELECTORES Y FORMULARIO
    // ===========================================
    function initAdminSelectors() {
      document.getElementById("adminCategory").value = adminCurrentCategory;
      renderAdminItems();
    }

    function getAdminListForCategory() {
      if (adminCurrentCategory === "canciones") return canciones;
      if (adminCurrentCategory === "autores") return autores;
      return curiosidades;
    }

    function renderAdminItems() {
      const select = document.getElementById("adminItem");
      const search = document.getElementById("adminSearch").value.trim().toLowerCase();
      const list = getAdminListForCategory();

      select.innerHTML = "";

      list
        .filter(item => {
          if (!search) return true;
          if (adminCurrentCategory === "canciones") {
            return (item.titulo || "").toLowerCase().includes(search) ||
              (item.interprete || "").toLowerCase().includes(search);
          } else if (adminCurrentCategory === "autores") {
            return (item.nombre_artistico || "").toLowerCase().includes(search) ||
              (item.nombre_real || "").toLowerCase().includes(search);
          } else {
            return (item.tema || "").toLowerCase().includes(search) ||
              (item.detalle || "").toLowerCase().includes(search);
          }
        })
        .forEach(item => {
          const label =
            adminCurrentCategory === "canciones"
              ? (item.titulo || "(sin t√≠tulo)")
              : adminCurrentCategory === "autores"
              ? (item.nombre_artistico || "(sin nombre art√≠stico)")
              : (item.tema || "(sin tema)");
          select.appendChild(el("option", { value: item.id }, label));
        });

      if (select.options.length > 0) {
        select.selectedIndex = 0;
        adminCurrentId = select.value;
        renderAdminForm();
      } else {
        adminCurrentId = null;
        renderAdminForm(); // vac√≠o
      }
    }

    function renderAdminForm() {
      const form = document.getElementById("adminForm");
      form.innerHTML = "";

      let item = null;
      if (adminCurrentId) {
        const list = getAdminListForCategory();
        item = list.find(x => x.id === adminCurrentId) || null;
      }

      if (adminCurrentCategory === "canciones") {
        form.appendChild(
          el("div", { class: "field-grid two" }, [
            el("div", {}, [
              el("label", { for: "fTitulo" }, "Canci√≥n"),
              el("input", { id: "fTitulo", type: "text", value: item?.titulo || "" })
            ]),
            el("div", {}, [
              el("label", { for: "fGenero" }, "G√©nero"),
              el("input", { id: "fGenero", type: "text", value: item?.genero || "" })
            ])
          ])
        );
        form.appendChild(
          el("div", { class: "field-grid two" }, [
            el("div", {}, [
              el("label", { for: "fInterprete" }, "Int√©rprete"),
              el("input", { id: "fInterprete", type: "text", value: item?.interprete || "" })
            ]),
            el("div", {}, [
              el("label", { for: "fCompositor" }, "Compositor"),
              el("input", { id: "fCompositor", type: "text", value: item?.compositor || "" })
            ])
          ])
        );
        form.appendChild(
          el("div", { class: "field-grid two" }, [
            el("div", {}, [
              el("label", { for: "fImagen" }, "Imagen (URL o ruta)"),
              el("input", { id: "fImagen", type: "text", value: item?.imagen || "" })
            ]),
            el("div", {}, [
              el("label", { for: "fVideo" }, "Video (URL)"),
              el("input", { id: "fVideo", type: "text", value: item?.video || "" })
            ])
          ])
        );
        form.appendChild(
          el("div", {}, [
            el("label", { for: "fTomadoDe" }, "Tomado de"),
            el("input", { id: "fTomadoDe", type: "text", value: item?.tomado_de || "" })
          ])
        );
        form.appendChild(
          el("div", {}, [
            el("label", { for: "fHistoria" }, "Historia"),
            el("textarea", { id: "fHistoria" }, item?.historia || "")
          ])
        );
      } else if (adminCurrentCategory === "autores") {
        form.appendChild(
          el("div", { class: "field-grid two" }, [
            el("div", {}, [
              el("label", { for: "fNombreArtistico" }, "Nombre art√≠stico"),
              el("input", { id: "fNombreArtistico", type: "text", value: item?.nombre_artistico || "" })
            ]),
            el("div", {}, [
              el("label", { for: "fNombreReal" }, "Nombre real"),
              el("input", { id: "fNombreReal", type: "text", value: item?.nombre_real || "" })
            ])
          ])
        );
        form.appendChild(
          el("div", { class: "field-grid two" }, [
            el("div", {}, [
              el("label", { for: "fRol" }, "Rol"),
              el("input", { id: "fRol", type: "text", value: item?.rol || "" })
            ]),
            el("div", {}, [
              el("label", { for: "fFoto" }, "Foto (URL o ruta)"),
              el("input", { id: "fFoto", type: "text", value: item?.foto || "" })
            ])
          ])
        );
        form.appendChild(
          el("div", {}, [
            el("label", { for: "fBiografia" }, "Biograf√≠a"),
            el("textarea", { id: "fBiografia" }, item?.biografia || "")
          ])
        );
        form.appendChild(
          el("div", {}, [
            el("label", { for: "fExitos" }, "√âxitos"),
            el("input", { id: "fExitos", type: "text", value: item?.exitos || "" })
          ])
        );
        form.appendChild(
          el("div", {}, [
            el("label", { for: "fCuriosidades" }, "Curiosidades"),
            el("input", { id: "fCuriosidades", type: "text", value: item?.curiosidades || "" })
          ])
        );
        form.appendChild(
          el("div", {}, [
            el("label", { for: "fTomadoDe" }, "Tomado de"),
            el("input", { id: "fTomadoDe", type: "text", value: item?.tomado_de || "" })
          ])
        );
      } else {
        // curiosidades
        form.appendChild(
          el("div", {}, [
            el("label", { for: "fTema" }, "Tema"),
            el("input", { id: "fTema", type: "text", value: item?.tema || "" })
          ])
        );
        form.appendChild(
          el("div", {}, [
            el("label", { for: "fDetalle" }, "Detalle"),
            el("textarea", { id: "fDetalle" }, item?.detalle || "")
          ])
        );
        form.appendChild(
          el("div", {}, [
            el("label", { for: "fImagenCurio" }, "Imagen (URL o ruta)"),
            el("input", { id: "fImagenCurio", type: "text", value: item?.imagen || "" })
          ])
        );
        form.appendChild(
          el("div", {}, [
            el("label", { for: "fTomadoDe" }, "Tomado de"),
            el("input", { id: "fTomadoDe", type: "text", value: item?.tomado_de || "" })
          ])
        );
      }
    }

    // ===========================================
    // ADMIN: GUARDAR / ELIMINAR / NUEVO
    // ===========================================
    async function guardarAdmin() {
      setAdminStatus("Guardando en Supabase...");
      try {
        if (adminCurrentCategory === "canciones") {
          const titulo = document.getElementById("fTitulo").value.trim();
          const genero = document.getElementById("fGenero").value.trim();
          const interprete = document.getElementById("fInterprete").value.trim();
          const compositor = document.getElementById("fCompositor").value.trim();
          const imagen = document.getElementById("fImagen").value.trim();
          const video = document.getElementById("fVideo").value.trim();
          const tomado_de = document.getElementById("fTomadoDe").value.trim();
          const historia = document.getElementById("fHistoria").value.trim();

          const payload = { titulo, genero, interprete, compositor, imagen, video, tomado_de, historia };

          if (adminCurrentId) {
            const { error } = await supabase
              .from("canciones")
              .update(payload)
              .eq("id", adminCurrentId);
            if (error) throw error;
          } else {
            const id = crypto.randomUUID ? crypto.randomUUID() : undefined;
            if (id) payload.id = id;
            const { error } = await supabase.from("canciones").insert(payload);
            if (error) throw error;
          }
        } else if (adminCurrentCategory === "autores") {
          const nombre_artistico = document.getElementById("fNombreArtistico").value.trim();
          const nombre_real = document.getElementById("fNombreReal").value.trim();
          const rol = document.getElementById("fRol").value.trim();
          const foto = document.getElementById("fFoto").value.trim();
          const biografia = document.getElementById("fBiografia").value.trim();
          const exitos = document.getElementById("fExitos").value.trim();
          const curiosidadesA = document.getElementById("fCuriosidades").value.trim();
          const tomado_de = document.getElementById("fTomadoDe").value.trim();

          const payload = { nombre_artistico, nombre_real, rol, foto, biografia, exitos, curiosidades: curiosidadesA, tomado_de };

          if (adminCurrentId) {
            const { error } = await supabase
              .from("autores")
              .update(payload)
              .eq("id", adminCurrentId);
            if (error) throw error;
          } else {
            const id = crypto.randomUUID ? crypto.randomUUID() : undefined;
            if (id) payload.id = id;
            const { error } = await supabase.from("autores").insert(payload);
            if (error) throw error;
          }
        } else {
          // curiosidades
          const tema = document.getElementById("fTema").value.trim();
          const detalle = document.getElementById("fDetalle").value.trim();
          const imagen = document.getElementById("fImagenCurio").value.trim();
          const tomado_de = document.getElementById("fTomadoDe").value.trim();

          const payload = { tema, detalle, imagen, tomado_de };

          if (adminCurrentId) {
            const { error } = await supabase
              .from("curiosidades")
              .update(payload)
              .eq("id", adminCurrentId);
            if (error) throw error;
          } else {
            const id = crypto.randomUUID ? crypto.randomUUID() : undefined;
            if (id) payload.id = id;
            const { error } = await supabase.from("curiosidades").insert(payload);
            if (error) throw error;
          }
        }

        incrementSaveCounter();
        setAdminStatus("Guardado correctamente en Supabase.", true);

        // recargar datos para ver la actualizaci√≥n
        await loadData();
      } catch (e) {
        console.error(e);
        setAdminStatus("Error al guardar en Supabase.", false);
      }
    }

    async function eliminarAdmin() {
      if (!adminCurrentId) {
        setAdminStatus("No hay √≠tem seleccionado para eliminar.", false);
        return;
      }
      const confirmar = confirm("¬øSeguro que deseas eliminar este √≠tem?");
      if (!confirmar) return;

      setAdminStatus("Eliminando √≠tem...");
      try {
        if (adminCurrentCategory === "canciones") {
          const { error } = await supabase
            .from("canciones")
            .delete()
            .eq("id", adminCurrentId);
          if (error) throw error;
        } else if (adminCurrentCategory === "autores") {
          const { error } = await supabase
            .from("autores")
            .delete()
            .eq("id", adminCurrentId);
          if (error) throw error;
        } else {
          const { error } = await supabase
            .from("curiosidades")
            .delete()
            .eq("id", adminCurrentId);
          if (error) throw error;
        }

        setAdminStatus("√çtem eliminado.", true);
        adminCurrentId = null;
        await loadData();
      } catch (e) {
        console.error(e);
        setAdminStatus("Error al eliminar en Supabase.", false);
      }
    }

    function nuevoAdminItem() {
      adminCurrentId = null;
      renderAdminForm();
      setAdminStatus("Nuevo √≠tem listo para editar. Recuerda presionar Guardar.");
    }

    // ===========================================
    // TABS & EVENTOS
    // ===========================================
    function initTabs() {
      const tabs = document.querySelectorAll(".tab-btn");
      const sections = {
        "canciones-section": document.getElementById("canciones-section"),
        "autores-section": document.getElementById("autores-section"),
        "curiosidades-section": document.getElementById("curiosidades-section"),
        "admin-section": document.getElementById("admin-section")
      };

      tabs.forEach(btn => {
        btn.addEventListener("click", () => {
          tabs.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const target = btn.getAttribute("data-section");
          Object.entries(sections).forEach(([id, sec]) => {
            sec.style.display = id === target ? "block" : "none";
          });
        });
      });
    }

    function initEvents() {
      // Filtros canciones
      document.getElementById("filterTipo").addEventListener("change", () => renderCancionesList());
      document.getElementById("filterValor").addEventListener("change", () => renderCancionesList());
      document.getElementById("orderCanciones").addEventListener("change", () => renderCancionesList());
      document.getElementById("searchCanciones").addEventListener("input", () => renderCancionesList());

      // Buscar autores / curiosidades
      document.getElementById("searchAutores").addEventListener("input", () => renderAutoresList());
      document.getElementById("searchCuriosidades").addEventListener("input", () => renderCuriosidadesList());

      // Admin
      document.getElementById("adminCategory").addEventListener("change", e => {
        adminCurrentCategory = e.target.value;
        adminCurrentId = null;
        renderAdminItems();
      });

      document.getElementById("adminSearch").addEventListener("input", () => renderAdminItems());
      document.getElementById("adminItem").addEventListener("change", e => {
        adminCurrentId = e.target.value || null;
        renderAdminForm();
      });

      document.getElementById("btnNuevoItem").addEventListener("click", nuevoAdminItem);
      document.getElementById("btnGuardar").addEventListener("click", guardarAdmin);
      document.getElementById("btnEliminar").addEventListener("click", eliminarAdmin);
      document.getElementById("btnRefrescar").addEventListener("click", loadData);
    }

    // ===========================================
    // INICIO
    // ===========================================
    document.addEventListener("DOMContentLoaded", async () => {
      initTabs();
      initEvents();
      await loadData();
    });
  </script>
</body>
</html>