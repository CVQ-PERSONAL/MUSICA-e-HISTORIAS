<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historias de M√∫sica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050509;
      --bg-elevated: #101018;
      --bg-elevated-soft: rgba(255, 255, 255, 0.03);
      --accent: #ffb347;
      --accent-soft: rgba(255, 179, 71, 0.2);
      --text: #f6f6f6;
      --muted: #a6a6bf;
      --border: #333548;
      --danger: #ff5c5c;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.55);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 8px;
    }
    ,::before,::after{box-sizing:border-box;}
    html,body{
      margin:0;padding:0;
      background:radial-gradient(circle at top,#151527 0,#050509 55%,#020205 100%);
      color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    body{min-height:100vh;display:flex;flex-direction:column;}

    .top-header{
      padding:1.5rem 5vw 1rem;
      border-bottom:1px solid rgba(255,255,255,.05);
      backdrop-filter:blur(12px);
      background:linear-gradient(to bottom,rgba(8,8,16,.95),rgba(8,8,16,.75),transparent);
    }
    .title-block{text-align:center;}
    h1{margin:0;font-size:clamp(1.8rem,3vw,2.4rem);letter-spacing:.08em;text-transform:uppercase;}
    .subtitle{margin:.3rem 0 0;font-size:.9rem;color:var(--muted);}

    .top-actions{
      margin-top:1rem;display:flex;gap:.75rem;flex-wrap:wrap;
      justify-content:center;align-items:center;
    }
    .search-wrapper{flex:1 1 260px;max-width:420px;}
    #searchBox{
      width:100%;padding:.65rem .9rem;border-radius:999px;
      border:1px solid var(--border);background:rgba(10,10,20,.9);
      color:var(--text);outline:none;box-shadow:inset 0 0 0 1px rgba(0,0,0,.6);
    }
    #searchBox::placeholder{color:rgba(180,180,210,.7);}
    #searchBox:focus{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent-soft);}
    .contact-btn{
      padding:.7rem 1.1rem;border-radius:999px;border:1px solid var(--accent);
      color:var(--accent);background:transparent;text-decoration:none;
      font-size:.9rem;display:inline-flex;align-items:center;gap:.4rem;cursor:pointer;
    }
    .contact-btn:hover{background:var(--accent-soft);}

    .main-nav{
      margin-top:1rem;display:flex;justify-content:center;gap:.5rem;flex-wrap:wrap;
    }
    .main-nav button{
      border-radius:999px;border:1px solid var(--border);
      background:rgba(12,12,24,.85);color:var(--text);
      padding:.55rem 1.2rem;cursor:pointer;font-size:.9rem;
      transition:background .15s ease,border .15s ease,transform .08s;
    }
    .main-nav button:hover{
      background:rgba(40,40,72,.9);border-color:var(--accent);transform:translateY(-1px);
    }

    .layout{
      flex:1;display:grid;grid-template-columns:minmax(240px,340px) minmax(0,1fr);
      gap:1.5rem;padding:1.5rem 5vw 1.75rem;
    }
    .sidebar{
      background:rgba(8,8,18,.9);border-radius:var(--radius-lg);
      box-shadow:var(--shadow-soft);border:1px solid rgba(255,255,255,.04);
      overflow:hidden;display:flex;flex-direction:column;min-height:0;
    }
    .viewer{
      background:rgba(7,7,16,.95);border-radius:var(--radius-lg);
      box-shadow:var(--shadow-soft);border:1px solid rgba(255,255,255,.04);
      padding:1rem 1.4rem 1.5rem;min-height:0;overflow:auto;
    }
    .admin{
      grid-column:1/-1;margin-top:1.25rem;background:rgba(5,5,12,.98);
      border-radius:var(--radius-lg);box-shadow:var(--shadow-soft);
      border:1px solid rgba(255,255,255,.06);padding:1.25rem 1.5rem 1.4rem;
    }
    .admin[hidden]{display:none!important;}

    .section-label{
      padding:.75rem 1rem;font-size:.85rem;text-transform:uppercase;
      letter-spacing:.18em;color:var(--muted);
      border-bottom:1px solid rgba(255,255,255,.03);
    }
    .item-list{list-style:none;margin:0;padding:0;overflow:auto;}
    .item{
      padding:.65rem .9rem;border-bottom:1px solid rgba(255,255,255,.03);
      cursor:pointer;transition:background .12s ease;font-size:.9rem;
    }
    .item:hover{background:rgba(255,255,255,.03);}
    .item-title{font-weight:600;}
    .item-meta{font-size:.78rem;color:var(--muted);}

    .card{
      max-width:780px;margin:0 auto;background:var(--bg-elevated);
      border-radius:var(--radius-lg);padding:1.4rem 1.5rem 1.6rem;
      box-shadow:var(--shadow-soft);border:1px solid rgba(255,255,255,.06);
    }
    .card h2{margin:0 0 .5rem;font-size:1.5rem;}
    .card-type{
      font-size:.78rem;text-transform:uppercase;letter-spacing:.18em;
      color:var(--muted);margin-bottom:.3rem;
    }
    .field{margin:.35rem 0;font-size:.92rem;line-height:1.5;}
    .field-label{font-weight:600;color:var(--accent);margin-right:.25rem;}
    .field-value.nd{opacity:.6;font-style:italic;}
    .field.long-text{margin-top:.7rem;}

    .media-frame{
      max-width:480px;margin:1.5rem auto;padding:.75rem;border-radius:12px;
      box-shadow:0 4px 18px rgba(0,0,0,.6);text-align:center;
      background:var(--bg-elevated-soft);
    }
    .media-frame img,.media-frame video{
      max-width:100%;height:auto;display:block;margin:0 auto;border-radius:10px;
    }
    .media-frame iframe,
    .media-frame .media-video {
      width: 100%;
      max-width: 100%;
      display: block;
      margin: 0 auto;
      border-radius: 10px;
    }
    .media-frame iframe {
      aspect-ratio: 16 / 9;
    }

    .empty-state{text-align:center;color:var(--muted);margin-top:3rem;}

    .admin h2{margin:0 0 .4rem;}
    .admin-note{margin:0 0 .9rem;font-size:.85rem;color:var(--muted);}
    .admin-controls{
      display:flex;flex-wrap:wrap;gap:.75rem 1rem;align-items:center;margin-bottom:.9rem;
    }
    .admin-controls label{font-size:.86rem;}
    .admin-controls select{
      margin-left:.3rem;padding:.2rem .35rem;border-radius:var(--radius-sm);
      border:1px solid var(--border);background:#161623;color:var(--text);
    }
    button.secondary{
      border-radius:999px;border:1px solid var(--border);background:#181824;
      color:var(--text);padding:.4rem .9rem;cursor:pointer;font-size:.85rem;
    }
    button.secondary:hover{border-color:var(--accent);background:rgba(255,255,255,.04);}

    .admin-form{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:.7rem 1rem;margin-top:.5rem;
    }
    .admin-field{display:flex;flex-direction:column;gap:.25rem;font-size:.86rem;}
    .admin-field label{font-weight:600;}
    .admin-field input[type="text"],.admin-field textarea{
      border-radius:var(--radius-sm);border:1px solid var(--border);
      background:#11111e;color:var(--text);padding:.35rem .45rem;
      font-size:.86rem;resize:vertical;min-height:2.1rem;
    }
    .admin-field textarea{min-height:4.2rem;}
    .admin-actions{
      grid-column:1/-1;display:flex;flex-wrap:wrap;gap:.6rem;margin-top:.4rem;
    }
    button.primary{
      border-radius:999px;border:none;background:linear-gradient(135deg,#ffb347,#ff7f50);
      color:#1a1208;padding:.55rem 1.1rem;cursor:pointer;font-weight:600;font-size:.9rem;
    }
    button.primary:hover{filter:brightness(1.05);}
    button.danger{
      border-radius:999px;border:1px solid var(--danger);background:transparent;
      color:var(--danger);padding:.45rem 1rem;cursor:pointer;font-size:.86rem;
    }
    button.danger:hover{background:rgba(255,92,92,.12);}

    .field.long-text .collapsible-toggle{
      margin-left:.3rem;
      font-size:.8rem;
      border:none;
      background:transparent;
      color:var(--accent);
      cursor:pointer;
      text-decoration:underline;
      padding:0;
    }

    #scrollTopBtn{
      position:fixed;
      right:1.5rem;
      bottom:1.5rem;
      background:rgba(0,0,0,.78);
      color:var(--accent);
      border:1px solid var(--accent);
      border-radius:999px;
      padding:.35rem .9rem;
      font-size:.8rem;
      cursor:pointer;
      z-index:100;
    }

    .footer{
      padding:.9rem 5vw 1.1rem;text-align:center;font-size:.78rem;
      color:var(--muted);border-top:1px solid rgba(255,255,255,.05);
    }

    @media(max-width:880px){
      .layout{grid-template-columns:1fr;}
      .sidebar{order:2;}
      .viewer{order:1;}
    }
    @media(max-width:540px){
      .top-header{padding-inline:1rem;}
      .layout{padding-inline:1rem;}
      .admin{padding-inline:1rem;}
    }
  </style>
</head>
<body>
  <header class="top-header">
    <div class="title-block">
      <h1>Historias de M√∫sica</h1>
      <p class="subtitle">Recopilado y programado por Carlos Vera Quintana</p>
    </div>

    <div class="top-actions">
      <div class="search-wrapper">
        <input
          id="searchBox"
          type="search"
          placeholder="Buscar en canciones, autores y curiosidades..."
          oninput="searchItems()"
          aria-label="Buscar"
        />
      </div>
      <a class="contact-btn" href="mailto:cveraq@gmail.com">Contacto</a>
    </div>

    <nav class="main-nav" aria-label="Secciones principales">
      <button type="button" onclick="switchView('canciones')">Canciones</button>
      <button type="button" onclick="switchView('autores')">Cantantes / Autores</button>
      <button type="button" onclick="switchView('curiosidades')">Curiosidades</button>
      <button type="button" onclick="showAdmin()">Admin</button>
    </nav>
  </header>

  <main class="layout">
    <section id="list" class="sidebar" aria-label="Listado de √≠tems"></section>

    <section id="viewer" class="viewer" aria-label="Detalle del √≠tem seleccionado">
      <div class="empty-state">
        <p>Selecciona una canci√≥n, autor o curiosidad para ver su historia.</p>
      </div>
    </section>

    <section id="admin" class="admin" aria-label="Administraci√≥n" hidden>
      <h2>Administraci√≥n</h2>
      <p class="admin-note">
        Edici√≥n local en este navegador. Los cambios se guardan en <code>localStorage</code>.
        Para hacerlos permanentes, exporta el JSON y s√∫belo a <code>data/historias.json</code> en GitHub.
      </p>

      <div class="admin-controls">
        <label>
          Categor√≠a:
          <select id="adminCategory" onchange="renderAdminItems(); loadAdminForm();">
            <option value="canciones">Canciones</option>
            <option value="autores">Cantantes / Autores</option>
            <option value="curiosidades">Curiosidades</option>
          </select>
        </label>

        <label>
          √çtem:
          <select id="adminItem" onchange="loadAdminForm()"></select>
        </label>

        <button type="button" class="secondary" onclick="addNewItem()">Agregar nuevo √≠tem</button>
        <button type="button" class="secondary" onclick="exportJson()">Exportar JSON (para GitHub)</button>
      </div>

      <form id="adminForm" class="admin-form" onsubmit="saveAdminForm(event)"></form>
    </section>
  </main>

  <footer class="footer">
    <small>Proyecto est√°tico ‚Äî Funciona en GitHub Pages o cualquier servidor web simple.</small>
  </footer>

  <button id="scrollTopBtn" type="button" onclick="scrollToTop()">‚ñ≤ Arriba</button>

<script>
// üîê CONFIGURACI√ìN DE ADMIN
const ADMIN_PASSWORD = "historia2025";
let adminUnlocked = false;

// üîê Clave para datos locales
const LS_KEY = "historias_musica_data_v4";

// ESQUEMA DE DATOS
const SCHEMA = {
  canciones: {
    label: "Canciones",
    typeLabel: "Canci√≥n",
    fields: ["Canci√≥n", "Int√©rprete", "Compositor", "Imagen", "Video", "Tomado de", "Historia"],
    longFields: ["Historia"],
    mediaFields: { image: "Imagen", video: "Video" }
  },
  autores: {
    label: "Cantantes / Autores",
    typeLabel: "Cantante / Autor",
    fields: [
      "Nombre art√≠stico",
      "Nombre real",
      "Int√©rprete o Compositor",
      "Foto",
      "Biograf√≠a",
      "√âxitos",
      "Curiosidades",
      "Tomado de"
    ],
    longFields: ["Biograf√≠a", "√âxitos", "Curiosidades"],
    mediaFields: { image: "Foto", video: null }
  },
  curiosidades: {
    label: "Curiosidades",
    typeLabel: "Curiosidad",
    fields: ["Tema", "Detalle", "Imagen", "Tomado de"],
    longFields: ["Detalle"],
    mediaFields: { image: "Imagen", video: null }
  }
};

// ESTADO GLOBAL
let data = { canciones: [], autores: [], curiosidades: [] };
let currentSection = "canciones";
let adminCurrentSection = "canciones";
let adminCurrentIndex = 0;

const normalize = (s) => (s || "").toLowerCase();
const clone = (o) => JSON.parse(JSON.stringify(o));

// INICIO
document.addEventListener("DOMContentLoaded", () => {
  init();
});

async function init() {
  try {
    const resp = await fetch("data/historias.json");
    if (!resp.ok) {
      throw new Error("No se pudo cargar data/historias.json");
    }
    const jsonData = await resp.json();
    if (!jsonData || typeof jsonData !== "object") {
      throw new Error("Formato inv√°lido en historias.json");
    }

    data.canciones = Array.isArray(jsonData.canciones) ? jsonData.canciones : [];
    data.autores = Array.isArray(jsonData.autores) ? jsonData.autores : [];
    data.curiosidades = Array.isArray(jsonData.curiosidades) ? jsonData.curiosidades : [];

    loadFromLocalStorage();
    switchView("canciones");
    renderAdminItems();
  } catch (e) {
    console.error(e);
    document.getElementById("viewer").innerHTML =
      "<div class='empty-state'><p>No se pudo cargar <code>data/historias.json</code>. " +
      "Crea el archivo con la estructura correcta en la carpeta <code>/data</code>.</p></div>";
  }
}

// ===== VISTA PRINCIPAL ===============================================
function switchView(section) {
  currentSection = section;
  document.getElementById("admin").hidden = true;

  renderList(section);

  const viewer = document.getElementById("viewer");
  if (data[section] && data[section].length > 0) {
    showItem(section, 0);
  } else {
    viewer.innerHTML =
      "<div class='empty-state'><p>Selecciona una " +
      SCHEMA[section].typeLabel.toLowerCase() +
      " para ver su historia.</p></div>";
  }

  window.scrollTo({ top: 0, behavior: "smooth" });
}

function renderList(section) {
  const container = document.getElementById("list");
  container.innerHTML = "";

  const label = document.createElement("div");
  label.className = "section-label";
  label.textContent = SCHEMA[section].label.toUpperCase();
  container.appendChild(label);

  const ul = document.createElement("ul");
  ul.className = "item-list";

  data[section].forEach((item, index) => {
    const li = document.createElement("li");
    li.className = "item";
    li.onclick = () => showItem(section, index);

    const title = document.createElement("div");
    title.className = "item-title";
    title.textContent = item.title || item.header;

    const meta = document.createElement("div");
    meta.className = "item-meta";
    meta.textContent = SCHEMA[section].typeLabel;

    li.appendChild(title);
    li.appendChild(meta);
    ul.appendChild(li);
  });

  if (!data[section].length) {
    const empty = document.createElement("div");
    empty.className = "empty-state";
    empty.innerHTML =
      "<p>No se encontraron elementos en esta categor√≠a. Revisa <code>data/historias.json</code>.</p>";
    container.appendChild(empty);
  } else {
    container.appendChild(ul);
  }
}

function clearViewerIfEmpty() {
  const viewer = document.getElementById("viewer");
  if (!viewer.innerHTML.trim()) {
    viewer.innerHTML =
      "<div class='empty-state'><p>Selecciona una canci√≥n, autor o curiosidad para ver su historia.</p></div>";
  }
}

// Texto largo colapsable
function applyCollapsibleText(container, fullText) {
  const MAX_CHARS = 280;
  if (!fullText || fullText.length <= MAX_CHARS) {
    container.innerText = fullText;
    return;
  }

  const shortText = fullText.slice(0, MAX_CHARS) + "‚Ä¶";

  const textSpan = document.createElement("span");
  const toggleBtn = document.createElement("button");
  toggleBtn.type = "button";
  toggleBtn.className = "collapsible-toggle";

  let expanded = false;

  function update() {
    textSpan.textContent = expanded ? fullText : shortText;
    toggleBtn.textContent = expanded ? "ver menos" : "ver m√°s";
  }

  update();

  toggleBtn.addEventListener("click", () => {
    expanded = !expanded;
    update();
  });

  container.innerHTML = "";
  container.appendChild(textSpan);
  container.appendChild(document.createTextNode(" "));
  container.appendChild(toggleBtn);
}

function showItem(section, index) {
  const viewer = document.getElementById("viewer");
  const item = data[section][index];
  const schema = SCHEMA[section];

  const card = document.createElement("article");
  card.className = "card";

  const typeSpan = document.createElement("div");
  typeSpan.className = "card-type";
  typeSpan.textContent = schema.typeLabel.toUpperCase();
  card.appendChild(typeSpan);

  const title = document.createElement("h2");
  title.textContent = item.title || item.header;
  card.appendChild(title);

  const imageFieldName = schema.mediaFields.image;
  const videoFieldName = schema.mediaFields.video;

  schema.fields.forEach((fieldName) => {
    if (fieldName === imageFieldName || fieldName === videoFieldName) return;
    const value = item.fields[fieldName] ?? "N/D";

    const fieldDiv = document.createElement("div");
    fieldDiv.className = "field";
    if (schema.longFields.includes(fieldName)) fieldDiv.classList.add("long-text");

    const labelSpan = document.createElement("span");
    labelSpan.className = "field-label";
    labelSpan.textContent = fieldName + ":";

    const valueSpan = document.createElement("span");
    valueSpan.className = "field-value";

    if (!value || value === "N/D") {
      valueSpan.textContent = "N/D";
      valueSpan.classList.add("nd");
    } else if (fieldName === "Tomado de" && /^https?:\/\//i.test(value)) {
      const link = document.createElement("a");
      link.href = value;
      link.target = "_blank";
      link.rel = "noreferrer";
      link.textContent = value;
      valueSpan.appendChild(link);
    } else if (schema.longFields.includes(fieldName)) {
      applyCollapsibleText(valueSpan, value);
    } else {
      valueSpan.innerText = value;
    }

    fieldDiv.appendChild(labelSpan);
    fieldDiv.appendChild(valueSpan);
    card.appendChild(fieldDiv);
  });

  // Imagen
  if (imageFieldName) {
    const imgSrc = (item.fields[imageFieldName] || "").trim();
    if (imgSrc && imgSrc !== "N/D") {
      const fig = document.createElement("figure");
      fig.className = "media-frame";
      const img = document.createElement("img");
      img.src = imgSrc;
      img.alt = item.title || schema.typeLabel;
      fig.appendChild(img);
      card.appendChild(fig);
    } else {
      const fieldDiv = document.createElement("div");
      fieldDiv.className = "field";
      const labelSpan = document.createElement("span");
      labelSpan.className = "field-label";
      labelSpan.textContent = imageFieldName + ":";
      const valueSpan = document.createElement("span");
      valueSpan.className = "field-value nd";
      valueSpan.textContent = "N/D";
      fieldDiv.appendChild(labelSpan);
      fieldDiv.appendChild(valueSpan);
      card.appendChild(fieldDiv);
    }
  }

  // Video
  if (videoFieldName) {
    const rawVal = item.fields[videoFieldName];
    const vidSrc = (rawVal || "").trim();

    if (!vidSrc || vidSrc === "N/D") {
      const fieldDiv = document.createElement("div");
      fieldDiv.className = "field";
      const labelSpan = document.createElement("span");
      labelSpan.className = "field-label";
      labelSpan.textContent = videoFieldName + ":";
      const valueSpan = document.createElement("span");
      valueSpan.className = "field-value nd";
      valueSpan.textContent = "N/D";
      fieldDiv.appendChild(labelSpan);
      fieldDiv.appendChild(valueSpan);
      card.appendChild(fieldDiv);
    } else {
      const fig = document.createElement("figure");
      fig.className = "media-frame";

      if (/^https?:\/\//i.test(vidSrc)) {
        let embedUrl = vidSrc;
        const ytWatch = vidSrc.match(/youtube\.com\/watch\?v=([^&]+)/i);
        const ytShort = vidSrc.match(/youtu\.be\/([^?]+)/i);

        if (ytWatch && ytWatch[1]) {
          embedUrl = "https://www.youtube.com/embed/" + ytWatch[1];
        } else if (ytShort && ytShort[1]) {
          embedUrl = "https://www.youtube.com/embed/" + ytShort[1];
        }

        const iframe = document.createElement("iframe");
        iframe.src = embedUrl;
        iframe.className = "media-iframe";
        iframe.setAttribute("frameborder", "0");
        iframe.setAttribute(
          "allow",
          "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        );
        iframe.allowFullscreen = true;
        iframe.title = item.title || "Video";

        fig.appendChild(iframe);
      } else {
        const vid = document.createElement("video");
        vid.controls = true;
        vid.src = vidSrc;
        vid.className = "media-video";
        fig.appendChild(vid);
      }

      card.appendChild(fig);
    }
  }

  viewer.innerHTML = "";
  viewer.appendChild(card);
}

// ===== B√öSQUEDA ======================================================
function searchItems() {
  const query = normalize(document.getElementById("searchBox").value);
  const list = document.getElementById("list");
  const viewer = document.getElementById("viewer");

  if (!query) {
    renderList(currentSection);
    clearViewerIfEmpty();
    return;
  }

  list.innerHTML = "";
  viewer.innerHTML =
    "<div class='empty-state'><p>Selecciona un resultado para ver el detalle.</p></div>";

  const label = document.createElement("div");
  label.className = "section-label";
  label.textContent = "Resultados de b√∫squeda";
  list.appendChild(label);

  const ul = document.createElement("ul");
  ul.className = "item-list";

  ["canciones", "autores", "curiosidades"].forEach((section) => {
    data[section].forEach((item, index) => {
      const hay =
        normalize(item.title).includes(query) ||
        normalize(item.header).includes(query) ||
        Object.values(item.fields).some((v) => normalize(v).includes(query));

      if (!hay) return;

      const li = document.createElement("li");
      li.className = "item";
      li.onclick = () => {
        currentSection = section;
        showItem(section, index);
      };

      const title = document.createElement("div");
      title.className = "item-title";
      title.textContent = item.title || item.header;

      const meta = document.createElement("div");
      meta.className = "item-meta";
      meta.textContent = SCHEMA[section].typeLabel;

      li.appendChild(title);
      li.appendChild(meta);
      ul.appendChild(li);
    });
  });

  if (!ul.children.length) {
    const empty = document.createElement("div");
    empty.className = "empty-state";
    empty.innerHTML = "<p>No se encontraron coincidencias.</p>";
    list.appendChild(empty);
  } else {
    list.appendChild(ul);
  }
}

// ===== ADMIN =========================================================
function showAdmin() {
  if (!adminUnlocked) {
    const pwd = prompt("Contrase√±a de administraci√≥n:");
    if (pwd !== ADMIN_PASSWORD) {
      alert("Contrase√±a incorrecta.");
      return;
    }
    adminUnlocked = true;
  }
  document.getElementById("admin").hidden = false;
  renderAdminItems();
  loadAdminForm();
}

function renderAdminItems() {
  const catSel = document.getElementById("adminCategory");
  const itemSel = document.getElementById("adminItem");
  adminCurrentSection = catSel.value;

  itemSel.innerHTML = "";
  data[adminCurrentSection].forEach((item, idx) => {
    const opt = document.createElement("option");
    opt.value = String(idx);
    opt.textContent = item.title || item.header;
    itemSel.appendChild(opt);
  });

  if (!data[adminCurrentSection].length) {
    const opt = document.createElement("option");
    opt.value = "-1";
    opt.textContent = "(No hay √≠tems)";
    itemSel.appendChild(opt);
  }

  adminCurrentIndex = itemSel.options.length ? Number(itemSel.value) || 0 : 0;
  loadAdminForm();
}

function loadAdminForm() {
  const form = document.getElementById("adminForm");
  const itemSel = document.getElementById("adminItem");
  adminCurrentIndex = Number(itemSel.value) || 0;

  form.innerHTML = "";
  const items = data[adminCurrentSection];
  if (!items.length || adminCurrentIndex < 0 || adminCurrentIndex >= items.length) {
    form.innerHTML =
      "<p class='empty-state'>No hay √≠tems en esta categor√≠a. Usa ‚ÄúAgregar nuevo √≠tem‚Äù.</p>";
    return;
  }

  const item = items[adminCurrentIndex];
  const schema = SCHEMA[adminCurrentSection];

  schema.fields.forEach((fieldName) => {
    const fieldDiv = document.createElement("div");
    fieldDiv.className = "admin-field";

    const label = document.createElement("label");
    label.textContent = fieldName + ":";
    label.htmlFor = "field-" + fieldName;
    fieldDiv.appendChild(label);

    const isLong = schema.longFields.includes(fieldName);
    const isMedia =
      fieldName === schema.mediaFields.image || fieldName === schema.mediaFields.video;

    let input;
    if (isLong) {
      input = document.createElement("textarea");
    } else {
      input = document.createElement("input");
      input.type = "text";
    }
    input.id = "field-" + fieldName;
    input.name = fieldName;
    input.value = item.fields[fieldName] === "N/D" ? "" : item.fields[fieldName];

    fieldDiv.appendChild(input);

    if (isMedia) {
      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept =
        fieldName === schema.mediaFields.video ? "video/" : "image/";
      fileInput.onchange = (ev) => {
        const file = ev.target.files[0];
        if (!file) return;
        const folder = fieldName === schema.mediaFields.video ? "videos" : "images";
        input.value = folder + "/" + file.name;
        alert(
          "Recuerda copiar el archivo " +
            file.name +
            " dentro de la carpeta /" + folder + " del proyecto."
        );
      };
      fieldDiv.appendChild(fileInput);
    }

    form.appendChild(fieldDiv);
  });

  const actions = document.createElement("div");
  actions.className = "admin-actions";

  const saveBtn = document.createElement("button");
  saveBtn.type = "submit";
  saveBtn.className = "primary";
  saveBtn.textContent = "Previsualizar y guardar";
  actions.appendChild(saveBtn);

  const deleteBtn = document.createElement("button");
  deleteBtn.type = "button";
  deleteBtn.className = "danger";
  deleteBtn.textContent = "Eliminar √≠tem";
  deleteBtn.onclick = deleteCurrentItem;
  actions.appendChild(deleteBtn);

  form.appendChild(actions);

  showItem(adminCurrentSection, adminCurrentIndex);
}

// Guardar con PREVIEW
function saveAdminForm(ev) {
  ev.preventDefault();

  const items = data[adminCurrentSection];
  if (!items.length) return;

  const original = items[adminCurrentIndex];
  const schema = SCHEMA[adminCurrentSection];

  const updated = clone(original);

  schema.fields.forEach((fieldName) => {
    const el = document.getElementById("field-" + fieldName);
    if (!el) return;
    const val = el.value.trim();
    updated.fields[fieldName] = val || "N/D";
  });

  if (adminCurrentSection === "canciones" && updated.fields["Canci√≥n"] !== "N/D") {
    updated.title = updated.fields["Canci√≥n"];
  } else if (
    adminCurrentSection === "autores" &&
    updated.fields["Nombre art√≠stico"] !== "N/D"
  ) {
    updated.title = updated.fields["Nombre art√≠stico"];
  } else if (
    adminCurrentSection === "curiosidades" &&
    updated.fields["Tema"] !== "N/D"
  ) {
    updated.title = updated.fields["Tema"];
  }

  data[adminCurrentSection][adminCurrentIndex] = updated;
  showItem(adminCurrentSection, adminCurrentIndex);

  const ok = confirm(
    "Est√°s viendo una PREVISUALIZACI√ìN.\n\n¬øQuieres publicar estos cambios en este navegador?"
  );

  if (ok) {
    saveToLocalStorage();
    renderList(currentSection);
    alert("Cambios guardados localmente. Recuerda exportar el JSON para subirlo a GitHub.");
  } else {
    data[adminCurrentSection][adminCurrentIndex] = original;
    showItem(adminCurrentSection, adminCurrentIndex);
  }
}

function deleteCurrentItem() {
  if (
    !confirm(
      "¬øSeguro que quieres eliminar este √≠tem? Esta acci√≥n solo afecta a los datos locales (y al JSON si luego lo exportas)."
    )
  )
    return;
  const arr = data[adminCurrentSection];
  if (!arr.length) return;
  arr.splice(adminCurrentIndex, 1);
  saveToLocalStorage();
  renderAdminItems();
  loadAdminForm();
  renderList(currentSection);
}

// Crear nuevo √≠tem
function addNewItem() {
  const section = adminCurrentSection;
  const schema = SCHEMA[section];
  const fields = {};
  schema.fields.forEach((f) => (fields[f] = "N/D"));

  let title = "Nuevo √≠tem";
  if (section === "canciones") title = "Nueva canci√≥n";
  if (section === "autores") title = "Nuevo autor";
  if (section === "curiosidades") title = "Nueva curiosidad";

  const item = {
    id: section + "-" + Date.now(),
    header: "",
    title,
    type: section,
    fields
  };

  data[section].push(item);
  saveToLocalStorage();
  renderAdminItems();

  const itemSel = document.getElementById("adminItem");
  itemSel.value = String(data[section].length - 1);
  loadAdminForm();
  renderList(section);
  currentSection = section;
}

// LOCALSTORAGE
function saveToLocalStorage() {
  try {
    localStorage.setItem(LS_KEY, JSON.stringify(clone(data)));
  } catch (e) {
    console.warn("No se pudo guardar en localStorage", e);
  }
}

function loadFromLocalStorage() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return;
    const stored = JSON.parse(raw);
    if (!stored || typeof stored !== "object") return;

    ["canciones", "autores", "curiosidades"].forEach((section) => {
      if (!Array.isArray(stored[section])) return;

      stored[section].forEach((savedItem) => {
        const idx = data[section].findIndex(
          (it) => it.id === savedItem.id || it.title === savedItem.title
        );
        if (idx >= 0) {
          data[section][idx].fields = savedItem.fields;
          data[section][idx].title = savedItem.title || data[section][idx].title;
        } else {
          data[section].push(savedItem);
        }
      });
    });
  } catch (e) {
    console.warn("No se pudo leer localStorage", e);
  }
}

// Exportar JSON para GitHub
function exportJson() {
  try {
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "historias.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    alert(
      "Se descarg√≥ historias.json.\n\n" +
      "Ahora s√∫belo a tu repositorio en la carpeta /data (data/historias.json) " +
      "reemplazando el contenido anterior."
    );
  } catch (e) {
    console.error("No se pudo exportar JSON", e);
    alert("Ocurri√≥ un error al exportar el JSON.");
  }
}

// Bot√≥n subir arriba
function scrollToTop() {
  window.scrollTo({ top: 0, behavior: "smooth" });
  const viewer = document.getElementById("viewer");
  if (viewer) viewer.scrollTop = 0;
}
</script>

</body>
</html>