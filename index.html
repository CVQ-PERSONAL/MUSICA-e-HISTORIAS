<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>M√∫sica e Historias</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg-gradient: radial-gradient(circle at top, #4f46e5 0, #020617 45%, #000 100%);
      --card-bg: rgba(15, 23, 42, 0.96);
      --card-soft: rgba(15, 23, 42, 0.88);
      --accent: #fb923c;
      --accent-soft: #fed7aa;
      --pill-bg: #0f172a;
      --pill-active: linear-gradient(135deg,#fb923c,#f97316);
      --pill-text: #f9fafb;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-soft: rgba(148, 163, 184, 0.25);
      --danger: #f97373;
      --success: #22c55e;
      --input-bg: #020617;
      --input-border: #1f2937;
      --shadow-soft: 0 22px 50px rgba(15, 23, 42, 0.9);
      --radius-lg: 24px;
      --radius-md: 16px;
      --radius-pill: 999px;
      --transition-fast: 0.15s ease-out;
      --transition-med: 0.22s ease-out;
      --font-main: system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-main);
      color: var(--text-main);
      background: var(--bg-gradient);
      background-attachment: fixed;
      -webkit-font-smoothing: antialiased;
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header {
      margin-bottom: 18px;
    }

    h1 {
      margin: 0;
      font-size: clamp(2.2rem, 3vw, 2.8rem);
      letter-spacing: 0.03em;
    }

    .subtitle {
      margin-top: 6px;
      font-size: 0.95rem;
      color: var(--text-muted);
      max-width: 620px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-top: 18px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }

    .tab {
      border-radius: var(--radius-pill);
      padding: 8px 18px;
      background: var(--pill-bg);
      color: var(--text-muted);
      font-size: 0.9rem;
      border: 1px solid transparent;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: background var(--transition-med), color var(--transition-med), transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast);
    }

    .tab span.count {
      font-size: 0.75rem;
      padding: 2px 9px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
    }

    .tab.active {
      background: var(--pill-active);
      color: var(--pill-text);
      box-shadow: 0 12px 25px rgba(248, 113, 113, 0.3);
      border-color: rgba(248, 250, 252, 0.18);
      transform: translateY(-1px);
    }

    .tab.active span.count {
      background: rgba(15, 23, 42, 0.9);
    }

    /* Card layout */
    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 18px 16px 20px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.18);
    }

    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 1.2rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Layout for song section */
    .song-layout {
      display: grid;
      grid-template-columns: minmax(0, 42%) minmax(0, 58%);
      gap: 16px;
    }

    @media (max-width: 768px) {
      .song-layout {
        grid-template-columns: minmax(0,1fr);
      }
    }

    /* Controls */
    .field-group {
      margin-bottom: 10px;
    }

    label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      display: block;
      margin-bottom: 4px;
    }

    select,
    input[type="text"],
    textarea {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-main);
      padding: 9px 12px;
      font-size: 0.9rem;
      outline: none;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), color var(--transition-fast);
    }

    textarea {
      border-radius: 12px;
      resize: vertical;
      min-height: 80px;
      font-size: 0.92rem;
      line-height: 1.35;
    }

    select:focus,
    input[type="text"]:focus,
    textarea:focus {
      border-color: #f97316;
      box-shadow: 0 0 0 1px rgba(248, 113, 22, 0.35);
    }

    .search-input {
      padding-left: 34px;
      position: relative;
    }

    .search-wrapper {
      position: relative;
    }

    .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.9rem;
      pointer-events: none;
      opacity: 0.9;
    }

    /* List items */
    .list {
      margin-top: 8px;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.35), rgba(15, 23, 42, 0.96));
      max-height: 420px;
      overflow-y: auto;
    }

    .list-item {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(15, 23, 42, 0.9);
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast);
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .list-item:hover {
      background: rgba(30, 64, 175, 0.45);
      transform: translateY(-1px);
    }

    .list-item.active {
      background: rgba(248, 113, 22, 0.22);
    }

    .list-item-title {
      font-weight: 600;
    }

    .list-item-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Detail panel */
    .detail-card {
      background: var(--card-soft);
      border-radius: var(--radius-md);
      padding: 14px 14px 12px;
      border: 1px solid rgba(55, 65, 81, 0.7);
      min-height: 180px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .detail-row {
      display: flex;
      gap: 6px;
      font-size: 0.88rem;
    }

    .detail-label {
      min-width: 90px;
      font-weight: 600;
      color: var(--text-muted);
    }

    .detail-value {
      flex: 1;
    }

    .pill-genre {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(30, 64, 175, 0.55);
    }

    .history-text {
      font-size: 0.9rem;
      line-height: 1.4;
      color: #e5e7eb;
      margin-top: 4px;
    }

    .btn-link {
      border: none;
      background: none;
      color: var(--accent-soft);
      font-size: 0.8rem;
      padding: 0;
      cursor: pointer;
      text-decoration: underline;
    }

    .btn-link:hover {
      color: #fed7aa;
    }

    .video-link {
      color: #93c5fd;
      font-size: 0.85rem;
      text-decoration: underline;
    }

    .video-link:hover {
      color: #bfdbfe;
    }

    /* Buttons */
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
    }

    .btn {
      border-radius: var(--radius-pill);
      border: none;
      padding: 8px 16px;
      font-size: 0.86rem;
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg,#fb923c,#f97316);
      color: #111827;
      box-shadow: 0 12px 25px rgba(248, 113, 22, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 32px rgba(248, 113, 22, 0.6);
    }

    .btn-secondary {
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .btn-secondary:hover {
      background: #111827;
      transform: translateY(-1px);
    }

    .btn-danger {
      background: #7f1d1d;
      color: #fecaca;
      border: 1px solid #b91c1c;
    }

    .btn-danger:hover {
      background: #991b1b;
    }

    .status-message {
      margin-top: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .status-ok {
      color: var(--success);
    }

    .status-error {
      color: var(--danger);
    }

    /* Admin */
    .admin-grid {
      display: grid;
      grid-template-columns: minmax(0, 38%) minmax(0, 62%);
      gap: 16px;
    }

    @media (max-width: 768px) {
      .admin-grid {
        grid-template-columns: minmax(0,1fr);
      }
    }

    .admin-fieldset {
      background: rgba(15, 23, 42, 0.9);
      border-radius: var(--radius-md);
      padding: 12px 12px 10px;
      border: 1px solid rgba(55, 65, 81, 0.7);
    }

    .admin-small {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .admin-count {
      font-weight: 600;
      color: #fecaca;
    }

    .input-inline {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .input-inline input[type="text"] {
      flex: 1;
    }

    .badge-counter {
      font-size: 0.78rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.5);
      color: #e5e7eb;
    }

  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>M√∫sica e Historias</h1>
      <p class="subtitle">
        Canciones con historia, cantantes y curiosidades de la m√∫sica latina. Ahora los datos viven en Supabase y la edici√≥n se hace desde la web.
      </p>

      <div class="tabs">
        <button class="tab active" data-tab="canciones">
          Canciones <span class="count" id="countCanciones">0</span>
        </button>
        <button class="tab" data-tab="autores">
          Cantantes / Autores <span class="count" id="countAutores">0</span>
        </button>
        <button class="tab" data-tab="curiosidades">
          Curiosidades <span class="count" id="countCuriosidades">0</span>
        </button>
        <button class="tab" data-tab="admin">
          Admin
        </button>
      </div>
    </header>

    <!-- Canciones -->
    <section id="tab-canciones" class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Canciones</div>
          <div class="card-subtitle">Explora por g√©nero, int√©rprete o busca por t√≠tulo.</div>
        </div>
      </div>

      <div class="song-layout">
        <!-- Panel de filtros + lista -->
        <div>
          <div class="field-group">
            <label for="songFilterType">Filtrar por</label>
            <select id="songFilterType">
              <option value="todos">Todos</option>
              <option value="genero">G√©nero</option>
              <option value="interprete">Int√©rprete</option>
            </select>
          </div>

          <div class="field-group">
            <label for="songFilterValue">(Opciones)</label>
            <select id="songFilterValue">
              <option value="todos">(todos)</option>
            </select>
          </div>

          <div class="field-group">
            <label for="songSort">Ordenar por</label>
            <select id="songSort">
              <option value="az">A ‚Üí Z</option>
              <option value="za">Z ‚Üí A</option>
            </select>
          </div>

          <div class="field-group">
            <label for="songSearch">Buscar canci√≥n</label>
            <div class="search-wrapper">
              <span class="search-icon">üîç</span>
              <input type="text" id="songSearch" class="search-input" placeholder="Escribe parte del t√≠tulo o del int√©rprete" />
            </div>
          </div>

          <div id="songList" class="list"></div>
        </div>

        <!-- Panel de detalle -->
        <div>
          <div class="detail-card" id="songDetail">
            <div class="detail-row">
              <div class="detail-label">Canci√≥n</div>
              <div class="detail-value" id="detailTitulo">Selecciona una canci√≥n en la lista</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Int√©rprete</div>
              <div class="detail-value" id="detailInterprete">ND</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Compositor</div>
              <div class="detail-value" id="detailCompositor">ND</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">G√©nero</div>
              <div class="detail-value" id="detailGenero"><span class="pill-genre">ND</span></div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Tomado de</div>
              <div class="detail-value" id="detailTomadoDe">ND</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Video</div>
              <div class="detail-value" id="detailVideo">ND</div>
            </div>
            <div class="detail-row" style="align-items:flex-start;">
              <div class="detail-label">Historia</div>
              <div class="detail-value">
                <div id="detailHistoria" class="history-text">ND</div>
                <button id="btnHistoriaToggle" class="btn-link" style="display:none;">Ver m√°s</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Autores -->
    <section id="tab-autores" class="card" style="display:none;">
      <div class="card-header">
        <div>
          <div class="card-title">Cantantes / Autores</div>
          <div class="card-subtitle">Listado de int√©rpretes y compositores con sus datos b√°sicos.</div>
        </div>
      </div>

      <div class="field-group">
        <label for="authorSearch">Buscar autor</label>
        <div class="search-wrapper">
          <span class="search-icon">üîç</span>
          <input type="text" id="authorSearch" class="search-input" placeholder="Escribe parte del nombre art√≠stico o real" />
        </div>
      </div>

      <div id="authorList" class="list"></div>
    </section>

    <!-- Curiosidades -->
    <section id="tab-curiosidades" class="card" style="display:none;">
      <div class="card-header">
        <div>
          <div class="card-title">Curiosidades</div>
          <div class="card-subtitle">Peque√±as historias, datos y an√©cdotas sobre la m√∫sica latina.</div>
        </div>
      </div>

      <div id="curiosidadesList" class="list"></div>
    </section>

    <!-- Admin -->
    <section id="tab-admin" class="card" style="display:none;">
      <div class="card-header">
        <div>
          <div class="card-title">Administraci√≥n</div>
          <div class="card-subtitle">
            Edici√≥n en l√≠nea. Los cambios se guardan directamente en Supabase.
          </div>
        </div>
        <div class="admin-small">
          Cambios guardados en esta sesi√≥n:
          <span id="adminSaveCounter" class="badge-counter">0</span>
        </div>
      </div>

      <div class="admin-grid">
        <!-- Selecci√≥n de √≠tem -->
        <div class="admin-fieldset">
          <div class="field-group">
            <label for="adminCategory">Categor√≠a</label>
            <select id="adminCategory">
              <option value="canciones">Canciones</option>
              <option value="autores">Cantantes / Autores</option>
              <option value="curiosidades">Curiosidades</option>
            </select>
          </div>

          <div class="field-group">
            <label>√çtem</label>
            <div class="input-inline">
              <input type="text" id="adminSearchItem" placeholder="Buscar √≠tem por nombre" />
            </div>
          </div>

          <div class="field-group">
            <select id="adminItemSelect"></select>
          </div>

          <div class="btn-row" style="margin-top:6px;">
            <button class="btn btn-primary" id="btnNuevoItem">Agregar nuevo √≠tem</button>
            <button class="btn btn-secondary" id="btnImportCsv">üìÇ Importar CSV</button>
          </div>

          <input type="file" id="csvFileInput" accept=".csv" style="display:none;" />

          <div class="status-message admin-small" id="adminInfo">
            Selecciona o crea un √≠tem para editarlo.
          </div>
        </div>

        <!-- Formulario din√°mico -->
        <div class="admin-fieldset">
          <!-- Bloque Canciones -->
          <div id="adminFormCanciones">
            <div class="field-group">
              <label for="adminSongTitulo">Canci√≥n</label>
              <input type="text" id="adminSongTitulo" />
            </div>
            <div class="field-group">
              <label for="adminSongInterprete">Int√©rprete</label>
              <input type="text" id="adminSongInterprete" />
            </div>
            <div class="field-group">
              <label for="adminSongCompositor">Compositor</label>
              <input type="text" id="adminSongCompositor" />
            </div>
            <div class="field-group">
              <label for="adminSongGenero">G√©nero</label>
              <input type="text" id="adminSongGenero" />
            </div>
            <div class="field-group">
              <label for="adminSongImagen">Imagen (URL)</label>
              <input type="text" id="adminSongImagen" />
            </div>
            <div class="field-group">
              <label for="adminSongVideo">Video (URL)</label>
              <input type="text" id="adminSongVideo" />
            </div>
            <div class="field-group">
              <label for="adminSongTomadoDe">Tomado de</label>
              <input type="text" id="adminSongTomadoDe" />
            </div>
            <div class="field-group">
              <label for="adminSongHistoria">Historia</label>
              <textarea id="adminSongHistoria"></textarea>
            </div>
          </div>

          <!-- Bloque Autores -->
          <div id="adminFormAutores" style="display:none;">
            <div class="field-group">
              <label for="adminAutorNombreArtistico">Nombre art√≠stico</label>
              <input type="text" id="adminAutorNombreArtistico" />
            </div>
            <div class="field-group">
              <label for="adminAutorNombreReal">Nombre real</label>
              <input type="text" id="adminAutorNombreReal" />
            </div>
            <div class="field-group">
              <label for="adminAutorRol">Rol</label>
              <input type="text" id="adminAutorRol" placeholder="Int√©rprete, compositor, grupo..." />
            </div>
            <div class="field-group">
              <label for="adminAutorFoto">Foto (URL)</label>
              <input type="text" id="adminAutorFoto" />
            </div>
            <div class="field-group">
              <label for="adminAutorBiografia">Biograf√≠a</label>
              <textarea id="adminAutorBiografia"></textarea>
            </div>
            <div class="field-group">
              <label for="adminAutorExitos">√âxitos</label>
              <textarea id="adminAutorExitos" placeholder="Lista de canciones separadas por comas"></textarea>
            </div>
            <div class="field-group">
              <label for="adminAutorCuriosidades">Curiosidades</label>
              <textarea id="adminAutorCuriosidades"></textarea>
            </div>
            <div class="field-group">
              <label for="adminAutorTomadoDe">Tomado de</label>
              <input type="text" id="adminAutorTomadoDe" />
            </div>
          </div>

          <!-- Bloque Curiosidades -->
          <div id="adminFormCuriosidades" style="display:none;">
            <div class="field-group">
              <label for="adminCurioTema">Tema</label>
              <input type="text" id="adminCurioTema" />
            </div>
            <div class="field-group">
              <label for="adminCurioDetalle">Detalle</label>
              <textarea id="adminCurioDetalle"></textarea>
            </div>
            <div class="field-group">
              <label for="adminCurioImagen">Imagen (URL)</label>
              <input type="text" id="adminCurioImagen" />
            </div>
            <div class="field-group">
              <label for="adminCurioTomadoDe">Tomado de</label>
              <input type="text" id="adminCurioTomadoDe" />
            </div>
          </div>

          <div class="btn-row" style="margin-top:10px;">
            <button class="btn btn-primary" id="btnGuardar">Guardar</button>
            <button class="btn btn-secondary" id="btnRefrescar">Refrescar desde Supabase</button>
            <button class="btn btn-danger" id="btnEliminar">Eliminar</button>
          </div>

          <div class="status-message" id="adminStatus"></div>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    // üëâ 1. IMPORTAR SUPABASE
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // üëâ 2. RELLENA ESTOS DOS VALORES CON LOS TUYOS
    const SUPABASE_URL = "https://ughnwwuputxmzzombrbg.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_pFU7leFyEi_01fTmji3pDw_NQdsOgVW";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Estado global
    let canciones = [];
    let autores = [];
    let curiosidades = [];

    let selectedSongId = null;
    let fullHistoryText = "";
    let historyExpanded = false;

    // Filtros canciones
    let songFilterType = "todos";
    let songFilterValue = "todos";
    let songSort = "az";
    let songSearch = "";

    // Admin
    let adminCurrentCategory = "canciones";
    let adminSelectedId = null;
    let adminSaveCounter = 0;

    const el = (id) => document.getElementById(id);

    function setAdminStatus(msg, ok = null) {
      const node = el("adminStatus");
      node.textContent = msg;
      node.classList.remove("status-ok", "status-error");
      if (ok === true) node.classList.add("status-ok");
      if (ok === false) node.classList.add("status-error");
    }

    function incrementSaveCounter() {
      adminSaveCounter += 1;
      el("adminSaveCounter").textContent = adminSaveCounter;
    }

    // ---- Carga inicial desde Supabase ----
    async function loadData() {
      try {
        const { data: d1, error: e1 } = await supabase
          .from("canciones")
          .select("*")
          .order("titulo", { ascending: true });
        if (e1) throw e1;
        canciones = d1 || [];

        const { data: d2, error: e2 } = await supabase
          .from("autores")
          .select("*")
          .order("nombre_artistico", { ascending: true });
        if (e2) throw e2;
        autores = d2 || [];

        const { data: d3, error: e3 } = await supabase
          .from("curiosidades")
          .select("*")
          .order("tema", { ascending: true });
        if (e3) throw e3;
        curiosidades = d3 || [];

        el("countCanciones").textContent = canciones.length;
        el("countAutores").textContent = autores.length;
        el("countCuriosidades").textContent = curiosidades.length;

        renderSongFilters();
        renderSongList();
        renderAuthors();
        renderCuriosidades();
        renderAdminItems();
      } catch (error) {
        console.error(error);
        setAdminStatus("Error al cargar datos desde Supabase.", false);
      }
    }

    // ---------- Canciones (filtros + lista + detalle) ----------
    function renderSongFilters() {
      const typeSelect = el("songFilterType");
      const valueSelect = el("songFilterValue");

      typeSelect.value = songFilterType;

      // Construye opciones seg√∫n tipo
      let optionsSet = new Set();
      if (songFilterType === "genero") {
        canciones.forEach((c) => {
          if (c.genero && c.genero.trim()) optionsSet.add(c.genero.trim());
        });
      } else if (songFilterType === "interprete") {
        canciones.forEach((c) => {
          if (c.interprete && c.interprete.trim())
            optionsSet.add(c.interprete.trim());
        });
      }

      // Siempre incluir "(todos)"
      valueSelect.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "todos";
      optAll.textContent = "(todos)";
      valueSelect.appendChild(optAll);

      if (songFilterType !== "todos") {
        Array.from(optionsSet)
          .sort((a, b) => a.localeCompare(b, "es"))
          .forEach((val) => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val;
            valueSelect.appendChild(opt);
          });
      }

      // Aseguramos que el select muestre el valor elegido
      if (songFilterValue && [...valueSelect.options].some(o => o.value === songFilterValue)) {
        valueSelect.value = songFilterValue;
      } else {
        songFilterValue = "todos";
        valueSelect.value = "todos";
      }
    }

    function applySongFilters() {
      let list = [...canciones];

      // Filtro tipo/valor
      if (songFilterType === "genero" && songFilterValue !== "todos") {
        list = list.filter((c) => (c.genero || "").trim() === songFilterValue);
      } else if (songFilterType === "interprete" && songFilterValue !== "todos") {
        list = list.filter(
          (c) => (c.interprete || "").trim() === songFilterValue
        );
      }

      // B√∫squeda
      if (songSearch.trim()) {
        const q = songSearch.toLowerCase();
        list = list.filter((c) => {
          const t = (c.titulo || "").toLowerCase();
          const i = (c.interprete || "").toLowerCase();
          return t.includes(q) || i.includes(q);
        });
      }

      // Orden
      list.sort((a, b) => {
        const da = (a.titulo || "").toLowerCase();
        const db = (b.titulo || "").toLowerCase();
        if (songSort === "az") return da.localeCompare(db, "es");
        return db.localeCompare(da, "es");
      });

      return list;
    }

    function renderSongList() {
      const listNode = el("songList");
      listNode.innerHTML = "";

      const filtered = applySongFilters();
      if (!filtered.length) {
        const empty = document.createElement("div");
        empty.className = "list-item";
        empty.textContent = "No se encontraron canciones.";
        listNode.appendChild(empty);
        return;
      }

      filtered.forEach((c) => {
        const item = document.createElement("div");
        item.className = "list-item";
        if (c.id === selectedSongId) item.classList.add("active");

        const title = document.createElement("div");
        title.className = "list-item-title";
        title.textContent = c.titulo || "Sin t√≠tulo";

        const meta = document.createElement("div");
        meta.className = "list-item-meta";
        const genero = c.genero && c.genero.trim() ? c.genero : "ND";
        meta.textContent = `${c.interprete || "ND"} ¬∑ ${genero}`;

        item.appendChild(title);
        item.appendChild(meta);

        item.addEventListener("click", () => {
          selectedSongId = c.id;
          showSongDetail(c);
          renderSongList(); // para destacar item activo
        });

        listNode.appendChild(item);
      });

      // Si no hay canci√≥n seleccionada, seleccionamos la primera
      if (!selectedSongId && filtered[0]) {
        selectedSongId = filtered[0].id;
        showSongDetail(filtered[0]);
        renderSongList();
      }
    }

    function safeValue(value) {
      const v = (value || "").toString().trim();
      return v.length ? v : "ND";
    }

    function showSongDetail(song) {
      el("detailTitulo").textContent = safeValue(song.titulo);
      el("detailInterprete").textContent = safeValue(song.interprete);
      el("detailCompositor").textContent = safeValue(song.compositor);
      const genero = safeValue(song.genero);
      el("detailGenero").innerHTML = `<span class="pill-genre">${genero}</span>`;
      el("detailTomadoDe").textContent = safeValue(song.tomado_de);

      const videoNode = el("detailVideo");
      const video = (song.video || "").trim();
      if (video) {
        videoNode.innerHTML = `<a href="${video}" target="_blank" rel="noopener" class="video-link">Ver en YouTube</a>`;
      } else {
        videoNode.textContent = "ND";
      }

      fullHistoryText = (song.historia || "").trim();
      const histNode = el("detailHistoria");
      const toggleBtn = el("btnHistoriaToggle");

      if (!fullHistoryText) {
        histNode.textContent = "ND";
        toggleBtn.style.display = "none";
      } else {
        historyExpanded = false;
        updateHistoryDisplay();
        toggleBtn.style.display = "inline-block";
      }
    }

    function updateHistoryDisplay() {
      const histNode = el("detailHistoria");
      const toggleBtn = el("btnHistoriaToggle");
      const limit = 260;
      if (!fullHistoryText) {
        histNode.textContent = "ND";
        toggleBtn.style.display = "none";
        return;
      }
      if (historyExpanded || fullHistoryText.length <= limit) {
        histNode.textContent = fullHistoryText;
        toggleBtn.textContent = "Ver menos";
      } else {
        histNode.textContent = fullHistoryText.slice(0, limit) + "‚Ä¶";
        toggleBtn.textContent = "Ver m√°s";
      }
    }

    // ---------- Autores ----------
    function renderAuthors() {
      const list = el("authorList");
      list.innerHTML = "";
      const q = (el("authorSearch").value || "").toLowerCase().trim();

      let arr = [...autores];
      if (q) {
        arr = arr.filter((a) => {
          const na = (a.nombre_artistico || "").toLowerCase();
          const nr = (a.nombre_real || "").toLowerCase();
          return na.includes(q) || nr.includes(q);
        });
      }
      if (!arr.length) {
        const item = document.createElement("div");
        item.className = "list-item";
        item.textContent = "No se encontraron autores.";
        list.appendChild(item);
        return;
      }
      arr.forEach((a) => {
        const item = document.createElement("div");
        item.className = "list-item";
        const title = document.createElement("div");
        title.className = "list-item-title";
        title.textContent = a.nombre_artistico || "ND";
        const meta = document.createElement("div");
        meta.className = "list-item-meta";
        const rol = a.rol || "ND";
        const real = a.nombre_real ? ` ¬∑ ${a.nombre_real}` : "";
        meta.textContent = `${rol}${real}`;
        item.appendChild(title);
        item.appendChild(meta);
        list.appendChild(item);
      });
    }

    // ---------- Curiosidades ----------
    function renderCuriosidades() {
      const list = el("curiosidadesList");
      list.innerHTML = "";
      if (!curiosidades.length) {
        const item = document.createElement("div");
        item.className = "list-item";
        item.textContent = "No hay curiosidades registradas.";
        list.appendChild(item);
        return;
      }
      curiosidades.forEach((c) => {
        const item = document.createElement("div");
        item.className = "list-item";
        const title = document.createElement("div");
        title.className = "list-item-title";
        title.textContent = c.tema || "Sin tema";
        const meta = document.createElement("div");
        meta.className = "list-item-meta";
        meta.textContent = (c.detalle || "").trim() || "ND";
        item.appendChild(title);
        item.appendChild(meta);
        list.appendChild(item);
      });
    }

    // ---------- Admin: carga de items ----------
    function renderAdminItems() {
      const sel = el("adminItemSelect");
      sel.innerHTML = "";
      const searchQ = (el("adminSearchItem").value || "").toLowerCase().trim();

      let arr = [];
      if (adminCurrentCategory === "canciones") arr = canciones;
      else if (adminCurrentCategory === "autores") arr = autores;
      else arr = curiosidades;

      arr = arr.filter((it) => {
        let label = "";
        if (adminCurrentCategory === "canciones") {
          label = it.titulo || "";
        } else if (adminCurrentCategory === "autores") {
          label = it.nombre_artistico || "";
        } else {
          label = it.tema || "";
        }
        return label.toLowerCase().includes(searchQ);
      });

      arr.forEach((it) => {
        const opt = document.createElement("option");
        opt.value = it.id;
        if (adminCurrentCategory === "canciones") {
          opt.textContent = it.titulo || "Sin t√≠tulo";
        } else if (adminCurrentCategory === "autores") {
          opt.textContent = it.nombre_artistico || "Sin nombre art√≠stico";
        } else {
          opt.textContent = it.tema || "Sin tema";
        }
        sel.appendChild(opt);
      });

      if (arr.length) {
        if (!adminSelectedId || !arr.some((x) => x.id === adminSelectedId)) {
          adminSelectedId = arr[0].id;
        }
        sel.value = adminSelectedId;
        loadAdminForm();
      } else {
        adminSelectedId = null;
        clearAdminForm();
      }
    }

    function clearAdminForm() {
      // Canciones
      el("adminSongTitulo").value = "";
      el("adminSongInterprete").value = "";
      el("adminSongCompositor").value = "";
      el("adminSongGenero").value = "";
      el("adminSongImagen").value = "";
      el("adminSongVideo").value = "";
      el("adminSongTomadoDe").value = "";
      el("adminSongHistoria").value = "";

      // Autores
      el("adminAutorNombreArtistico").value = "";
      el("adminAutorNombreReal").value = "";
      el("adminAutorRol").value = "";
      el("adminAutorFoto").value = "";
      el("adminAutorBiografia").value = "";
      el("adminAutorExitos").value = "";
      el("adminAutorCuriosidades").value = "";
      el("adminAutorTomadoDe").value = "";

      // Curiosidades
      el("adminCurioTema").value = "";
      el("adminCurioDetalle").value = "";
      el("adminCurioImagen").value = "";
      el("adminCurioTomadoDe").value = "";
    }

    function loadAdminForm() {
      if (!adminSelectedId) {
        clearAdminForm();
        return;
      }
      let item = null;
      if (adminCurrentCategory === "canciones") {
        item = canciones.find((c) => c.id === adminSelectedId);
      } else if (adminCurrentCategory === "autores") {
        item = autores.find((a) => a.id === adminSelectedId);
      } else {
        item = curiosidades.find((c) => c.id === adminSelectedId);
      }
      if (!item) {
        clearAdminForm();
        return;
      }

      if (adminCurrentCategory === "canciones") {
        el("adminSongTitulo").value = item.titulo || "";
        el("adminSongInterprete").value = item.interprete || "";
        el("adminSongCompositor").value = item.compositor || "";
        el("adminSongGenero").value = item.genero || "";
        el("adminSongImagen").value = item.imagen || "";
        el("adminSongVideo").value = item.video || "";
        el("adminSongTomadoDe").value = item.tomado_de || "";
        el("adminSongHistoria").value = item.historia || "";
      } else if (adminCurrentCategory === "autores") {
        el("adminAutorNombreArtistico").value =
          item.nombre_artistico || "";
        el("adminAutorNombreReal").value = item.nombre_real || "";
        el("adminAutorRol").value = item.rol || "";
        el("adminAutorFoto").value = item.foto || "";
        el("adminAutorBiografia").value = item.biografia || "";
        el("adminAutorExitos").value = item.exitos || "";
        el("adminAutorCuriosidades").value = item.curiosidades || "";
        el("adminAutorTomadoDe").value = item.tomado_de || "";
      } else {
        el("adminCurioTema").value = item.tema || "";
        el("adminCurioDetalle").value = item.detalle || "";
        el("adminCurioImagen").value = item.imagen || "";
        el("adminCurioTomadoDe").value = item.tomado_de || "";
      }
    }

    function nuevoAdminItem() {
      clearAdminForm();
      adminSelectedId = null;
      el("adminItemSelect").value = "";
      setAdminStatus("Nuevo √≠tem listo para ser guardado.", null);
    }

    async function guardarAdmin() {
      let payload = {};
      let table = "";
      if (adminCurrentCategory === "canciones") {
        table = "canciones";
        payload = {
          titulo: el("adminSongTitulo").value.trim(),
          interprete: el("adminSongInterprete").value.trim(),
          compositor: el("adminSongCompositor").value.trim(),
          genero: el("adminSongGenero").value.trim(),
          imagen: el("adminSongImagen").value.trim(),
          video: el("adminSongVideo").value.trim(),
          tomado_de: el("adminSongTomadoDe").value.trim(),
          historia: el("adminSongHistoria").value.trim(),
        };
      } else if (adminCurrentCategory === "autores") {
        table = "autores";
        payload = {
          nombre_artistico: el("adminAutorNombreArtistico").value.trim(),
          nombre_real: el("adminAutorNombreReal").value.trim(),
          rol: el("adminAutorRol").value.trim(),
          foto: el("adminAutorFoto").value.trim(),
          biografia: el("adminAutorBiografia").value.trim(),
          exitos: el("adminAutorExitos").value.trim(),
          curiosidades: el("adminAutorCuriosidades").value.trim(),
          tomado_de: el("adminAutorTomadoDe").value.trim(),
        };
      } else {
        table = "curiosidades";
        payload = {
          tema: el("adminCurioTema").value.trim(),
          detalle: el("adminCurioDetalle").value.trim(),
          imagen: el("adminCurioImagen").value.trim(),
          tomado_de: el("adminCurioTomadoDe").value.trim(),
        };
      }

      try {
        if (adminSelectedId) {
          const { error } = await supabase
            .from(table)
            .update(payload)
            .eq("id", adminSelectedId);
          if (error) throw error;
        } else {
          const { data, error } = await supabase
            .from(table)
            .insert(payload)
            .select()
            .single();
          if (error) throw error;
          adminSelectedId = data.id;
        }

        incrementSaveCounter();
        setAdminStatus("Cambios guardados correctamente.", true);
        await loadData();
      } catch (error) {
        console.error(error);
        setAdminStatus("Error al guardar el √≠tem.", false);
      }
    }

    async function eliminarAdmin() {
      if (!adminSelectedId) {
        setAdminStatus("No hay √≠tem seleccionado para eliminar.", false);
        return;
      }
      if (!confirm("¬øEliminar este √≠tem?")) return;

      let table = "";
      if (adminCurrentCategory === "canciones") table = "canciones";
      else if (adminCurrentCategory === "autores") table = "autores";
      else table = "curiosidades";

      try {
        const { error } = await supabase
          .from(table)
          .delete()
          .eq("id", adminSelectedId);
        if (error) throw error;

        incrementSaveCounter();
        setAdminStatus("√çtem eliminado correctamente.", true);
        adminSelectedId = null;
        await loadData();
      } catch (error) {
        console.error(error);
        setAdminStatus("Error al eliminar el √≠tem.", false);
      }
    }

    // ---------- Importar CSV desde Admin ----------
    function parseCsv(text) {
      const lines = text.split(/\r?\n/).filter((l) => l.trim() !== "");
      if (!lines.length) return [];

      const headers = lines[0].split(",").map((h) => h.trim());
      const rows = [];

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;
        const values = line.split(",");
        const obj = {};
        headers.forEach((h, idx) => {
          obj[h] = (values[idx] || "").trim();
        });
        rows.push(obj);
      }
      return rows;
    }

    async function importarCsvParaCategoria(file) {
      if (!file) return;
      const cat = adminCurrentCategory;
      setAdminStatus(`Leyendo CSV para la categor√≠a ${cat}...`);

      try {
        const text = await file.text();
        let rows = parseCsv(text);
        if (!rows.length) {
          setAdminStatus("El CSV no contiene filas.", false);
          return;
        }

        let table = "";
        if (cat === "canciones") {
          table = "canciones";
          rows = rows.map((r) => ({
            titulo: r.titulo || r.Canci√≥n || "",
            interprete: r.interprete || r.interprete || "",
            compositor: r.compositor || r.Compositor || "",
            genero: r.genero || r.G√©nero || "",
            imagen: r.imagen || "",
            video: r.video || r.video_url || "",
            tomado_de: r.tomado_de || "",
            historia: r.historia || "",
          }));
        } else if (cat === "autores") {
          table = "autores";
          rows = rows.map((r) => ({
            nombre_artistico:
              r.nombre_artistico || r["Nombre art√≠stico"] || "",
            nombre_real: r.nombre_real || r["Nombre real"] || "",
            rol: r.rol || "",
            foto: r.foto || "",
            biografia: r.biografia || "",
            exitos: r.exitos || "",
            curiosidades: r.curiosidades || "",
            tomado_de: r.tomado_de || "",
          }));
        } else {
          table = "curiosidades";
          rows = rows.map((r) => ({
            tema: r.tema || r.Tema || "",
            detalle: r.detalle || r.Detalle || "",
            imagen: r.imagen || "",
            tomado_de: r.tomado_de || "",
          }));
        }

        rows = rows.filter((r) =>
          Object.values(r).some((v) => (v || "").trim() !== "")
        );
        if (!rows.length) {
          setAdminStatus("No se encontraron filas v√°lidas en el CSV.", false);
          return;
        }

        setAdminStatus(
          `Importando ${rows.length} registros en la tabla ${table}...`
        );

        const chunkSize = 50;
        for (let i = 0; i < rows.length; i += chunkSize) {
          const chunk = rows.slice(i, i + chunkSize);
          const { error } = await supabase.from(table).insert(chunk);
          if (error) {
            console.error(error);
            setAdminStatus("Error al importar algunos registros.", false);
            return;
          }
        }

        incrementSaveCounter();
        setAdminStatus(
          `Importaci√≥n completada: ${rows.length} registros agregados.`,
          true
        );
        await loadData();
      } catch (e) {
        console.error(e);
        setAdminStatus("Error al procesar el CSV.", false);
      }
    }

    // ---------- Tabs y eventos ----------
    function initTabs() {
      const tabs = document.querySelectorAll(".tab");
      tabs.forEach((t) => {
        t.addEventListener("click", () => {
          const tabId = t.dataset.tab;
          tabs.forEach((x) => x.classList.remove("active"));
          t.classList.add("active");

          ["canciones", "autores", "curiosidades", "admin"].forEach((id) => {
            el("tab-" + id).style.display = id === tabId ? "block" : "none";
          });

          // Limpia b√∫squeda cuando cambias de pesta√±a
          if (tabId === "canciones") {
            songSearch = "";
            el("songSearch").value = "";
            renderSongList();
          } else if (tabId === "autores") {
            el("authorSearch").value = "";
            renderAuthors();
          }
        });
      });
    }

    function initEvents() {
      // Canciones
      el("songFilterType").addEventListener("change", (e) => {
        songFilterType = e.target.value;
        songFilterValue = "todos";
        songSearch = "";
        el("songSearch").value = "";
        renderSongFilters();
        renderSongList();
      });

      el("songFilterValue").addEventListener("change", (e) => {
        songFilterValue = e.target.value;
        renderSongList();
      });

      el("songSort").addEventListener("change", (e) => {
        songSort = e.target.value;
        renderSongList();
      });

      el("songSearch").addEventListener("input", (e) => {
        songSearch = e.target.value;
        renderSongList();
      });

      el("btnHistoriaToggle").addEventListener("click", () => {
        historyExpanded = !historyExpanded;
        updateHistoryDisplay();
      });

      // Autores
      el("authorSearch").addEventListener("input", renderAuthors);

      // Admin
      el("adminCategory").addEventListener("change", (e) => {
        adminCurrentCategory = e.target.value;
        adminSelectedId = null;
        // Cambiar formulario visible
        el("adminFormCanciones").style.display =
          adminCurrentCategory === "canciones" ? "block" : "none";
        el("adminFormAutores").style.display =
          adminCurrentCategory === "autores" ? "block" : "none";
        el("adminFormCuriosidades").style.display =
          adminCurrentCategory === "curiosidades" ? "block" : "none";

        el("adminSearchItem").value = "";
        renderAdminItems();
      });

      el("adminItemSelect").addEventListener("change", (e) => {
        adminSelectedId = e.target.value || null;
        loadAdminForm();
      });

      el("adminSearchItem").addEventListener("input", () => {
        renderAdminItems();
      });

      el("btnNuevoItem").addEventListener("click", nuevoAdminItem);
      el("btnGuardar").addEventListener("click", guardarAdmin);
      el("btnEliminar").addEventListener("click", eliminarAdmin);
      el("btnRefrescar").addEventListener("click", loadData);

      el("btnImportCsv").addEventListener("click", () => {
        const input = el("csvFileInput");
        input.value = "";
        input.click();
      });

      el("csvFileInput").addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        importarCsvParaCategoria(file);
      });
    }

    // Init
    initTabs();
    initEvents();
    loadData();
  </script>
</body>
</html>